<!-- Chosen Palette: Warm Neutral (Tailwind Slate/Stone com Acento Azul) -->
<!-- Layout: Menu Lateral Fixo com Ecrã de Login -->
<!DOCTYPE html>
<html lang="pt-br" style="font-size: 15px; --font-family: 'Inter', sans-serif;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGAP - Sistema de Gestão de Atividades e Pautas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Novas fontes importadas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Slab:wght@400;500;700&family=Inconsolata:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        // Lógica de autenticação alterada para Login real + Bypass de Pré-visualização
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile, 
            // Adicionados de volta para o bypass da pré-visualização
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            limit 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        
        // Importação do Firebase Storage
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";
        
        // Adicionado Analytics
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";

        // --- Configuração ---
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        const userFirebaseConfig = {
            apiKey: "AIzaSyBZ76yd8RbRQVjbJ115QqL3oDztxedq0OY",
            authDomain: "agmm-16a91.firebaseapp.com",
            projectId: "agmm-16a91",
            storageBucket: "agmm-16a91.firebasestorage.app",
            messagingSenderId: "784096179999",
            appId: "1:784096179999:web:239ebaf0547bd88e24622a",
            measurementId: "G-B56XH56SLB"
        };
        
        const firebaseConfig = firebaseConfigFromEnv || userFirebaseConfig;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sgap-default-app';
        
        let db, auth, userId;
        let app, storage; 
        let analytics; 
        let firestoreListeners = []; // Array para guardar listeners

        // --- Collections ---
        let cargosCollection, funcionariosCollection, atividadesCollection, clientesCollection, tarefasPadraoCollection, usuariosCollection, settingsCollection;
        const cargosPath = `/artifacts/${appId}/public/data/cargos`;
        const funcionariosPath = `/artifacts/${appId}/public/data/funcionarios`;
        const atividadesPath = `/artifacts/${appId}/public/data/atividades`;
        const clientesPath = `/artifacts/${appId}/public/data/clientes`;
        const tarefasPadraoPath = `/artifacts/${appId}/public/data/tarefasPadrao`;
        const usuariosPath = `/artifacts/${appId}/public/data/usuarios`; // Para funções (roles)
        const settingsPath = `/artifacts/${appId}/public/data/settings`; // Para Personalização

        // --- Estado Global da Aplicação ---
        const state = {
            cargos: [],
            funcionarios: [],
            atividades: [],
            clientes: [],
            tarefasPadrao: [],
            usuarios: [], // Para o painel de admin
            siteSettings: {}, // Para Personalização
            currentMainView: 'pautas', 
            currentPautasView: 'calendario', 
            currentAdminView: 'funcionarios', 
            currentDate: new Date(),
            editingId: null,
            editingCollection: null,
            filterPeriodo: 'semana', 
            filterFuncionario: 'todos',
            filterCargo: 'todos',
            filterCliente: 'todos',
            filterTarefa: 'todos', 
            isAuthReady: false,
            dashboardChart: null, 
            dashboardDoughnutChart: null,
            isSidebarMinimized: false,
            themeColor: '#648AAE', 
            
            // Estado de Autenticação
            currentUser: null,
            userRole: null, // 'admin', 'editor', 'leitor'
        };

        // --- DOM Elements ---
        const dom = {};

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();
            setupUIEventListeners();
            loadStateFromLocalStorage(); // Carrega filtros e abas
            initFirebase();
            applyThemeFromLocalStorage(); // Aplica tema salvo
        });

        function cacheDOMElements() {
            // Vistas Principais
            dom.appView = document.getElementById('app-view');
            dom.loginView = document.getElementById('login-view'); 
            dom.mainViewPautas = document.getElementById('main-view-pautas');
            dom.mainViewDashboard = document.getElementById('main-view-dashboard');
            dom.mainViewAdmin = document.getElementById('main-view-admin');
            
            // Menu Lateral
            dom.sidebarMenu = document.getElementById('sidebar-menu');
            dom.sidebarTitle = document.getElementById('sidebar-title');
            dom.sidebarTitleH1 = document.getElementById('sidebar-title-h1');
            dom.sidebarToggleButton = document.getElementById('sidebar-toggle-button');
            dom.mainContentWrapper = document.getElementById('main-content-wrapper');

            dom.menuPautas = document.getElementById('menu-pautas');
            dom.menuPautasText = document.getElementById('menu-pautas-text');
            dom.menuDashboard = document.getElementById('menu-dashboard');
            dom.menuDashboardText = document.getElementById('menu-dashboard-text');
            dom.menuAdmin = document.getElementById('menu-admin');
            dom.menuAdminText = document.getElementById('menu-admin-text');
            dom.menuTema = document.getElementById('menu-tema');
            dom.menuTemaText = document.getElementById('menu-tema-text');
            dom.btnLancarAtividadeMenu = document.getElementById('btn-lancar-atividade-menu');
            dom.btnLancarAtividadeMenuText = document.getElementById('btn-lancar-atividade-menu-text');

            // Conteúdo
            dom.filtrosGlobaisContainer = document.getElementById('filtros-globais');
            dom.pautasContent = document.getElementById('pautas-content');
            dom.dashboardContent = document.getElementById('dashboard-content');
            dom.adminContent = document.getElementById('admin-content');
            dom.pautasNav = document.getElementById('pautas-nav');
            dom.adminNav = document.getElementById('admin-nav');
            
            // Botão Sair
            dom.btnLogout = document.getElementById('btn-logout');

            // Modals
            dom.modal = document.getElementById('modal');
            dom.modalTitle = document.getElementById('modal-title');
            dom.modalContent = document.getElementById('modal-content');
            dom.modalLoading = document.getElementById('modal-loading');
            dom.btnModalClose = document.getElementById('btn-modal-close');
            dom.btnModalCancel = document.getElementById('btn-modal-cancel');
            dom.btnModalSave = document.getElementById('btn-modal-save');
            
            dom.confirmDeleteModal = document.getElementById('confirm-delete-modal');
            dom.btnConfirmDelete = document.getElementById('btn-confirm-delete');
            dom.btnCancelDelete = document.getElementById('btn-cancel-delete');

            dom.toast = document.getElementById('toast');
            dom.toastMessage = document.getElementById('toast-message');

            dom.userIdDisplay = document.getElementById('user-id-display');
            dom.userIdDisplayWrapper = document.getElementById('user-id-wrapper'); 
            
            // Filtros
            dom.filterPeriodo = document.getElementById('filter-periodo');
            dom.filterFuncionario = document.getElementById('filter-funcionario');
            dom.filterCargo = document.getElementById('filter-cargo');
            dom.filterCliente = document.getElementById('filter-cliente');
            dom.filterTarefa = document.getElementById('filter-tarefa'); 
            
            // Modal de Tema
            dom.themeModal = document.getElementById('theme-modal');
            dom.themeModalClose = document.getElementById('theme-modal-close');
            dom.themeQuickSereno = document.getElementById('theme-quick-sereno');
            dom.themeQuickSolar = document.getElementById('theme-quick-solar');
            dom.themeQuickLaranja = document.getElementById('theme-quick-laranja');
            dom.themeColorPicker = document.getElementById('theme-color-picker');
            dom.themeHexInput = document.getElementById('theme-hex-input');
            dom.themeFontSelect = document.getElementById('theme-font-select');
            dom.themeFontSizeDecrease = document.getElementById('theme-font-size-decrease');
            dom.themeFontSizeIncrease = document.getElementById('theme-font-size-increase');
            dom.themeReset = document.getElementById('theme-reset');
            
            // Ecrã de Login
            dom.loginForm = document.getElementById('login-form');
            dom.loginNameWrapper = document.getElementById('login-name-wrapper'); 
            dom.loginName = document.getElementById('login-name'); 
            dom.loginEmail = document.getElementById('login-email');
            dom.loginPassword = document.getElementById('login-password');
            dom.loginEmailBtn = document.getElementById('login-email-btn');
            dom.loginMessage = document.getElementById('login-message');
            dom.loginTitle = document.getElementById('login-title');
            dom.toggleToCreate = document.getElementById('toggle-to-create');
            dom.toggleToLogin = document.getElementById('toggle-to-login');
        }
        
        // --- Funções Utilitárias de Tema ---
        function getLuminance(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return (0.2126 * r + 0.7152 * g + 0.0722 * b); // per ITU-R BT.709
        }
        
        function shadeColor(color, percent) {
            if (!color || !color.startsWith('#') || (color.length !== 4 && color.length !== 7)) {
                console.warn("Cor inválida para shadeColor:", color);
                color = '#648AAE'; // Cor padrão (Azul Sereno)
            }
            
            let R, G, B;
            if (color.length === 4) { // Formato #RGB
                R = parseInt(color[1] + color[1], 16);
                G = parseInt(color[2] + color[2], 16);
                B = parseInt(color[3] + color[3], 16);
            } else { // Formato #RRGGBB
                R = parseInt(color.substring(1,3),16);
                G = parseInt(color.substring(3,5),16);
                B = parseInt(color.substring(5,7),16);
            }

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R<255)?R:255;  
            G = (G<255)?G:255;  
            B = (B<255)?B:255;  
            
            R = (R>0)?R:0;
            G = (G>0)?G:0;
            B = (B>0)?B:0;

            const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

            return "#"+RR+GG+BB;
        }

        async function initFirebase() {
            try {
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); 
                analytics = getAnalytics(app); 

                cargosCollection = collection(db, cargosPath);
                funcionariosCollection = collection(db, funcionariosPath);
                atividadesCollection = collection(db, atividadesPath);
                clientesCollection = collection(db, clientesPath);
                tarefasPadraoCollection = collection(db, tarefasPadraoPath);
                usuariosCollection = collection(db, usuariosPath);
                settingsCollection = collection(db, settingsPath);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Utilizador está logado
                        userId = user.uid;
                        state.currentUser = user;
                        
                        await checkUserRole(user); // Define/Cria a função do utilizador
                        
                        dom.userIdDisplay.textContent = user.displayName || user.email || `ID: ${userId.substring(0, 8)}...`; 
                        state.isAuthReady = true;
                        
                        // Mostra app, esconde login
                        dom.appView.classList.remove('hidden');
                        dom.loginView.classList.add('hidden');

                        // Ouve as definições do site DEPOIS de autenticado
                        const settingsDocRef = doc(db, settingsPath, "globalConfig");
                        onSnapshot(settingsDocRef, (doc) => {
                            if (doc.exists()) {
                                console.log("Definições do site carregadas.");
                                state.siteSettings = doc.data();
                                applySiteSettings(state.siteSettings);
                            } else {
                                console.log("Nenhum documento de definições encontrado, a usar padrões.");
                                applySiteSettings(null); // Aplica padrões
                            }
                        }, (error) => {
                            console.error("Erro ao ouvir definições do site:", error);
                            applySiteSettings(null); // Aplica padrões em caso de erro
                        });

                        await seedInitialData(); 
                        
                        setupFirestoreListeners();
                        render(); // Renderiza a view correta
                    } else {
                        // Ninguém logado
                        userId = null;
                        state.currentUser = null;
                        state.userRole = null;
                        state.isAuthReady = false;
                        
                        // --- INÍCIO DA CORREÇÃO (BYPASS PRÉ-VISUALIZAÇÃO) ---
                        const isPreview = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token);

                        if (isPreview) {
                            // MODO PRÉ-VISUALIZAÇÃO: Tenta login automático para bypassar o ecrã
                            console.log("Modo de pré-visualização detetado. A tentar login automático...");
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (authError) {
                                console.error("Erro no login automático de pré-visualização:", authError);
                                dom.appView.classList.add('hidden');
                                dom.loginView.classList.remove('hidden');
                            }
                        } else {
                            // MODO PUBLICADO (GITHUB): Mostra o ecrã de login normal
                            dom.appView.classList.add('hidden');
                            dom.loginView.classList.remove('hidden');
                        }
                        // --- FIM DA CORREÇÃO ---
                        
                        // Limpa listeners antigos se existirem
                        firestoreListeners.forEach(unsubscribe => unsubscribe());
                        firestoreListeners = [];
                    }
                });
            } catch (error) {
                // Erro na inicialização (ex: config errada)
                console.error("Erro ao inicializar Firebase:", error);
                dom.loginMessage.textContent = "Erro grave de configuração. Verifique a consola.";
                dom.appView.classList.add('hidden');
                dom.loginView.classList.remove('hidden');
            }
        }
        
        async function checkUserRole(user) {
            const userDocRef = doc(db, usuariosPath, user.uid);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                state.userRole = userDoc.data().role;
            } else {
                // Novo usuário
                const adminQuery = query(usuariosCollection, where('role', '==', 'admin'), limit(1));
                const adminSnapshot = await getDocs(adminQuery);
                
                let newRole;
                let userName;
                let userEmail;

                if (user.isAnonymous) {
                    // Lógica para utilizador anónimo (bypass da pré-visualização)
                    newRole = 'admin'; // Damos 'admin' na pré-visualização para poder testar tudo
                    userName = 'Admin (Preview)';
                    userEmail = null; // Anónimo não tem email
                } else {
                    // Lógica de registo de email normal (para GitHub)
                    newRole = adminSnapshot.empty ? 'admin' : 'leitor'; // Primeiro usuário = admin
                    userName = user.displayName || (user.email ? user.email.split('@')[0] : 'Novo Usuário');
                    userEmail = user.email;
                }
                
                const newUserProfile = {
                    email: userEmail, 
                    nome: userName,
                    role: newRole,
                    uid: user.uid,
                    photoURL: user.photoURL || `https://placehold.co/100x100/${shadeColor(state.themeColor || '#648AAE', 70).substring(1)}/${shadeColor(state.themeColor || '#648AAE', -20).substring(1)}?text=${userName[0].toUpperCase()}`
                };
                
                await setDoc(userDocRef, newUserProfile);
                state.userRole = newRole;
            }
            console.log(`Usuário ${user.email || user.uid} logado com função: ${state.userRole}`);
        }

        // --- Nova Função: Aplicar Personalização Global ---
        function applySiteSettings(settings) {
            if (!settings) return; // Usa padrões do CSS

            const root = document.documentElement;
            // Aplica Cores
            root.style.setProperty('--color-bg', settings.colorBg || '#F4F7FA');
            root.style.setProperty('--color-card', settings.colorCard || '#FFFFFF');
            root.style.setProperty('--color-text-primary', settings.colorText || '#1f2937');
            root.style.setProperty('--color-text-secondary', shadeColor(settings.colorText || '#1f2937', 40));
            
            const accentColor = settings.colorAccent || '#648AAE';
            root.style.setProperty('--color-accent', accentColor);
            root.style.setProperty('--color-accent-dark', shadeColor(accentColor, -20));
            root.style.setProperty('--color-accent-darker', shadeColor(accentColor, -30));
            root.style.setProperty('--color-accent-light', shadeColor(accentColor, 70));
            root.style.setProperty('--color-accent-light-hover', shadeColor(accentColor, 85));
            const accentLuminance = getLuminance(accentColor);
            root.style.setProperty('--color-accent-text', accentLuminance > 140 ? '#1f2937' : '#FFFFFF');

            const sidebarColor = settings.colorSidebar || 'var(--color-accent)';
            root.style.setProperty('--color-sidebar', sidebarColor);
            const sidebarLuminance = getLuminance(sidebarColor);
            const sidebarTextColor = sidebarLuminance > 140 ? '#1f2937' : '#FFFFFF';
            root.style.setProperty('--color-sidebar-text', sidebarTextColor);
            root.style.setProperty('--color-sidebar-bg-hover', shadeColor(sidebarColor, sidebarLuminance > 140 ? -10 : 10));
            root.style.setProperty('--color-sidebar-text-hover', sidebarTextColor);

            // Aplica Cores de Status Globais
            const colorPendente = settings.colorStatusPendente || '#F97422'; // Laranja Padrão
            root.style.setProperty('--color-status-pendente', colorPendente);
            root.style.setProperty('--color-status-pendente-light', shadeColor(colorPendente, 80));
            root.style.setProperty('--color-status-pendente-dark', shadeColor(colorPendente, -30));

            const colorEmAndamento = settings.colorStatusEmAndamento || '#10B981'; // Verde Padrão
            root.style.setProperty('--color-status-em-andamento', colorEmAndamento);
            root.style.setProperty('--color-status-em-andamento-light', shadeColor(colorEmAndamento, 80));
            root.style.setProperty('--color-status-em-andamento-dark', shadeColor(colorEmAndamento, -30));
            
            const colorBloqueado = settings.colorStatusBloqueado || '#EF4444'; // Vermelho Padrão
            root.style.setProperty('--color-status-bloqueado', colorBloqueado);
            root.style.setProperty('--color-status-bloqueado-light', shadeColor(colorBloqueado, 80));
            root.style.setProperty('--color-status-bloqueado-dark', shadeColor(colorBloqueado, -30));
            
            // 'Concluído' usa a cor Accent
            root.style.setProperty('--color-status-concluido', 'var(--color-accent)');
            root.style.setProperty('--color-status-concluido-light', 'var(--color-accent-light)');
            root.style.setProperty('--color-status-concluido-dark', 'var(--color-accent-dark)');

            // Aplica Textos
            if (dom.sidebarTitleH1) dom.sidebarTitleH1.innerHTML = settings.sidebarTitle || '<span class="font-normal">Gestão de</span> Pautas';
            if (dom.menuPautasText) dom.menuPautasText.textContent = settings.menuPautas_text || 'Pautas';
            if (dom.btnLancarAtividadeMenuText) dom.btnLancarAtividadeMenuText.textContent = settings.menuLancar_text || 'Lançar Atividade';
            if (dom.menuDashboardText) dom.menuDashboardText.textContent = settings.menuDashboard_text || 'Dashboard';
            if (dom.menuAdminText) dom.menuAdminText.textContent = settings.menuAdmin_text || 'Administrativo';
            if (dom.menuTemaText) dom.menuTemaText.textContent = settings.menuTema_text || 'Tema';
        }

        function setupFirestoreListeners() {
            firestoreListeners.forEach(unsubscribe => unsubscribe());
            firestoreListeners = [];

            if (!state.isAuthReady || !state.userRole) {
                 console.warn("Usuário sem função, não é possível ler dados.");
                 return;
            }

            let listener;
            listener = onSnapshot(query(cargosCollection), (snapshot) => {
                state.cargos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.cargos.sort((a, b) => a.nome.localeCompare(b.nome));
                render();
            }, (error) => console.error("Erro ao ouvir 'cargos':", error));
            firestoreListeners.push(listener);

            listener = onSnapshot(query(funcionariosCollection), (snapshot) => {
                state.funcionarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.funcionarios.sort((a, b) => a.nome.localeCompare(b.nome));
                render();
            }, (error) => console.error("Erro ao ouvir 'funcionarios':", error));
            firestoreListeners.push(listener);

            listener = onSnapshot(query(atividadesCollection), (snapshot) => {
                state.atividades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (error) => console.error("Erro ao ouvir 'atividades':", error));
            firestoreListeners.push(listener);
            
            listener = onSnapshot(query(clientesCollection), (snapshot) => {
                state.clientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.clientes.sort((a, b) => a.nome.localeCompare(b.nome));
                render();
            }, (error) => console.error("Erro ao ouvir 'clientes':", error));
            firestoreListeners.push(listener);

            listener = onSnapshot(query(tarefasPadraoCollection), (snapshot) => {
                state.tarefasPadrao = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.tarefasPadrao.sort((a, b) => a.nome.localeCompare(b.nome));
                render(); 
            }, (error) => console.error("Erro ao ouvir 'tarefasPadrao':", error));
            firestoreListeners.push(listener);
            
            if (state.userRole === 'admin') {
                listener = onSnapshot(query(usuariosCollection), (snapshot) => {
                    state.usuarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.usuarios.sort((a, b) => a.nome.localeCompare(b.nome));
                    renderAdmin(); 
                }, (error) => console.error("Erro ao ouvir 'usuarios':", error));
                firestoreListeners.push(listener);
            }
        }

        // --- Event Handlers ---
        function setupUIEventListeners() {
            // Ecrã de Login
            dom.loginEmailBtn.addEventListener('click', handleEmailLoginOrCreate);
            dom.toggleToCreate.addEventListener('click', () => toggleLoginMode(true));
            dom.toggleToLogin.addEventListener('click', () => toggleLoginMode(false));
            dom.btnLogout.addEventListener('click', () => signOut(auth)); // Botão Sair
            
            // Navegação
            dom.menuPautas.addEventListener('click', () => switchMainView('pautas'));
            dom.menuDashboard.addEventListener('click', () => switchMainView('dashboard'));
            dom.menuAdmin.addEventListener('click', () => switchMainView('admin'));
            dom.menuTema.addEventListener('click', () => dom.themeModal.classList.remove('hidden'));
            dom.btnLancarAtividadeMenu.addEventListener('click', () => openModal('atividade'));

            // Navegação Secundária (Delegação)
            dom.pautasNav.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-view]');
                if (btn) switchPautasView(btn.dataset.view);
            });
            dom.adminNav.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-view]');
                if (btn) switchAdminView(btn.dataset.view);
            });

            // Ações (Delegação)
            dom.adminContent.addEventListener('click', handleAdminContentClick);
            dom.pautasContent.addEventListener('click', handlePautasContentClick);

            // Filtros
            dom.filterPeriodo.addEventListener('change', handleFilterChange);
            dom.filterFuncionario.addEventListener('change', handleFilterChange);
            dom.filterCargo.addEventListener('change', handleFilterChange);
            dom.filterCliente.addEventListener('change', handleFilterChange);
            dom.filterTarefa.addEventListener('change', handleFilterChange); 

            // Modals
            dom.btnModalClose.addEventListener('click', closeModal);
            dom.btnModalCancel.addEventListener('click', closeModal);
            dom.btnModalSave.addEventListener('click', handleModalSave);

            dom.btnCancelDelete.addEventListener('click', () => dom.confirmDeleteModal.classList.add('hidden'));
            dom.btnConfirmDelete.addEventListener('click', handleConfirmDelete);
            
            // Modal de Tema
            dom.themeModalClose.addEventListener('click', () => dom.themeModal.classList.add('hidden'));
            dom.themeQuickSereno.addEventListener('click', () => applyTheme('sereno'));
            dom.themeQuickSolar.addEventListener('click', () => applyTheme('solar'));
            dom.themeQuickLaranja.addEventListener('click', () => applyTheme('laranja'));
            dom.themeReset.addEventListener('click', resetTheme);

            dom.themeColorPicker.addEventListener('input', handleColorChange);
            dom.themeHexInput.addEventListener('input', handleHexChange);
            dom.themeFontSelect.addEventListener('change', (e) => applyTheme(null, e.target.value));
            dom.themeFontSizeDecrease.addEventListener('click', () => adjustFontSize(-1));
            dom.themeFontSizeIncrease.addEventListener('click', () => adjustFontSize(1));
            
            // Menu Lateral
            dom.sidebarToggleButton.addEventListener('click', toggleSidebar);
        }
        
        // --- Funções de Autenticação ---
        function toggleLoginMode(isCreatingAccount) {
            if (isCreatingAccount) {
                dom.loginTitle.textContent = 'Criar Conta';
                dom.loginEmailBtn.textContent = 'Criar Conta';
                dom.toggleToCreate.classList.add('hidden');
                dom.toggleToLogin.classList.remove('hidden');
                dom.loginNameWrapper.classList.remove('hidden'); // Mostra campo Nome
            } else {
                dom.loginTitle.textContent = 'Aceder à Plataforma';
                dom.loginEmailBtn.textContent = 'Entrar com Email';
                dom.toggleToCreate.classList.remove('hidden');
                dom.toggleToLogin.classList.add('hidden');
                dom.loginNameWrapper.classList.add('hidden'); // Esconde campo Nome
            }
        }
        
        async function handleEmailLoginOrCreate(e) {
            e.preventDefault();
            const email = dom.loginEmail.value;
            const password = dom.loginPassword.value;
            const nome = dom.loginName.value;
            
            const isCreating = dom.toggleToCreate.classList.contains('hidden');
            
            dom.loginMessage.textContent = "";

            try {
                if (isCreating) {
                    if (!nome || !email || !password) {
                        dom.loginMessage.textContent = "Por favor, preencha nome, email e senha.";
                        return;
                    }
                    dom.loginMessage.textContent = "Criando conta...";
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: nome });
                } else {
                    if (!email || !password) {
                        dom.loginMessage.textContent = "Por favor, preencha email e senha.";
                        return;
                    }
                    dom.loginMessage.textContent = "A entrar...";
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Erro no login/registo:", error);
                if (error.code === 'auth/email-already-in-use') {
                    dom.loginMessage.textContent = "Este email já está em uso. Tente fazer login.";
                } else if (error.code === 'auth/weak-password') {
                    dom.loginMessage.textContent = "A senha deve ter pelo menos 6 caracteres.";
                } else if (error.code === 'auth/invalid-credential') {
                     dom.loginMessage.textContent = "Email ou senha incorretos.";
                } else {
                    dom.loginMessage.textContent = `Erro: ${error.message}`;
                }
            }
        }

        function handleAdminContentClick(e) {
            // Apenas admin pode mexer no painel
            if (state.userRole !== 'admin') {
                showToast("Apenas 'admins' podem aceder a esta área.", 'error');
                return;
            }

            const btn = e.target.closest('button');
            if (btn) {
                const action = btn.dataset.action;
                const id = btn.dataset.id;
                
                if (action === 'add') {
                    openModal(state.currentAdminView);
                } else if (action === 'edit') {
                    openModal(state.currentAdminView, id);
                } else if (action === 'delete') {
                    // Modificado: Define a coleção correta
                    const collectionToDelete = (state.currentAdminView === 'todas-pautas') ? 'atividade' : state.currentAdminView;
                    openDeleteModal(id, collectionToDelete);
                } else if (action === 'save-settings') {
                    // Ação para salvar Personalização
                    handleSaveSettings();
                } else if (action === 'search-pautas') {
                    // Adicionado: Ação para o botão de busca
                    renderAdminTodasPautas();
                }
            }
            
            // Handler para a mudança de 'role'
            const select = e.target.closest('select[data-action="change-role"]');
            if (select) {
                const uid = select.dataset.uid;
                const newRole = select.value;
                if (uid && newRole) {
                    updateUserRole(uid, newRole);
                }
            }
        }
        
        // --- Nova Função: Salvar Personalização ---
        async function handleSaveSettings() {
            if (state.userRole !== 'admin') return;
            
            dom.btnModalSave.disabled = true;
                
            const form = document.getElementById('settings-form');
            if (!form) return;
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            const settings = {
                // Cores
                colorBg: data.colorBg,
                colorCard: data.colorCard,
                colorText: data.colorText,
                colorSidebar: data.colorSidebar,
                colorAccent: data.colorAccent,
                // Textos
                sidebarTitle: data.sidebarTitle,
                menuPautas_text: data.menuPautas_text,
                menuLancar_text: data.menuLancar_text,
                menuDashboard_text: data.menuDashboard_text,
                menuAdmin_text: data.menuAdmin_text,
                menuTema_text: data.menuTema_text,
            };

            try {
                const settingsDocRef = doc(db, settingsPath, "globalConfig");
                await setDoc(settingsDocRef, settings, { merge: true }); // Merge para não sobrescrever
                showToast("Personalização salva com sucesso!", 'success');
            } catch (error) {
                console.error("Erro ao salvar personalização:", error);
                showToast("Erro ao salvar personalização.", 'error');
            } finally {
                dom.btnModalSave.disabled = false;
            }
        }
        
        async function updateUserRole(uid, newRole) {
            if (uid === state.currentUser.uid) {
                showToast("Não pode alterar a sua própria função.", 'error');
                renderAdmin(); // Reverte a seleção visualmente
                return;
            }
            
            try {
                const userDocRef = doc(db, usuariosPath, uid);
                await updateDoc(userDocRef, { role: newRole });
                showToast("Função do usuário atualizada com sucesso.", 'success');
            } catch (error) {
                console.error("Erro ao atualizar função:", error);
                showToast("Erro ao atualizar função.", 'error');
            }
        }
        
        function handlePautasContentClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.dataset.action;
            const id = target.dataset.id;
            
            if (action === 'edit' || action === 'delete') {
                if (state.userRole === 'leitor') {
                    showToast("Apenas 'editores' e 'admins' podem alterar dados.", 'error');
                    return;
                }
                
                if (action === 'edit') {
                    openModal('atividade', id);
                } else if (action === 'delete') {
                    openDeleteModal(id, 'atividade');
                }
            }
            
            if (action === 'prev-month') {
                state.currentDate.setMonth(state.currentDate.getMonth() - 1);
                renderPautas();
            } else if (action === 'next-month') {
                state.currentDate.setMonth(state.currentDate.getMonth() + 1);
                renderPautas();
            } else if (action === 'prev-week') {
                state.currentDate.setDate(state.currentDate.getDate() - 7);
                renderPautas();
            } else if (action === 'next-week') {
                state.currentDate.setDate(state.currentDate.getDate() + 7);
                renderPautas();
            } else if (action === 'today') {
                state.currentDate = new Date();
                renderPautas();
            }
        }
        
        function handleFilterChange(e) {
            const id = e.target.id;
            const value = e.target.value;
            
            if (id === 'filter-periodo') {
                state.filterPeriodo = value;
                localStorage.setItem('sgap_filterPeriodo', value); 
            }
            if (id === 'filter-funcionario') {
                state.filterFuncionario = value;
                localStorage.setItem('sgap_filterFuncionario', value); 
            }
            if (id === 'filter-cargo') {
                state.filterCargo = value;
                localStorage.setItem('sgap_filterCargo', value); 
            }
            if (id === 'filter-cliente') {
                state.filterCliente = value;
                localStorage.setItem('sgap_filterCliente', value); 
            }
            if (id === 'filter-tarefa') {
                state.filterTarefa = value; 
                localStorage.setItem('sgap_filterTarefa', value); 
            }
            
            render();
        }
        
        // --- Funções de Tema ---
        
        function handleColorChange(e) {
            const newColor = e.target.value;
            dom.themeHexInput.value = newColor;
            applyTheme('custom', null, newColor);
        }

        function handleHexChange(e) {
            const newHex = e.target.value;
            if (/^#[0-9A-F]{6}$/i.test(newHex)) {
                dom.themeColorPicker.value = newHex;
                applyTheme('custom', null, newHex);
            }
        }
        
        function applyTheme(themeName, font, customColor) {
            const root = document.documentElement;
            
            if (themeName) {
                root.classList.remove('theme-solar', 'theme-laranja', 'theme-custom');
                let accentColor;

                if (themeName === 'solar') {
                    accentColor = '#FFC82E';
                    root.classList.add('theme-solar');
                } else if (themeName === 'laranja') {
                    accentColor = '#F97422';
                    root.classList.add('theme-laranja');
                } else if (themeName === 'sereno') {
                    accentColor = '#648AAE';
                } else if (themeName === 'custom' && customColor) {
                    accentColor = customColor;
                    root.classList.add('theme-custom');
                } else {
                    accentColor = state.themeColor; 
                }
                
                if (accentColor) {
                    state.themeColor = accentColor; 
                    root.style.setProperty('--color-accent', accentColor);
                    
                    const darkColor = shadeColor(accentColor, -20);
                    const darkerColor = shadeColor(accentColor, -30);
                    root.style.setProperty('--color-accent-dark', darkColor);
                    root.style.setProperty('--color-accent-darker', darkerColor);

                    const lightColor = shadeColor(accentColor, 70);
                    const lighterColor = shadeColor(accentColor, 85);
                    root.style.setProperty('--color-accent-light', lightColor);
                    root.style.setProperty('--color-accent-light-hover', lighterColor);

                    const luminance = getLuminance(accentColor);
                    const textColor = luminance > 140 ? '#1f2937' : '#FFFFFF'; 
                    root.style.setProperty('--color-accent-text', textColor);
                    
                    dom.themeColorPicker.value = accentColor;
                    dom.themeHexInput.value = accentColor;
                }
                
                localStorage.setItem('sgap_theme_name', themeName);
                if (themeName === 'custom') {
                    localStorage.setItem('sgap_theme_custom_color', customColor);
                }
            }

            if (font) {
                const fontMap = {
                    'Inter': "'Inter', sans-serif",
                    'Roboto Slab': "'Roboto Slab', serif",
                    'Inconsolata': "'Inconsolata', monospace"
                };
                const newFontFamily = fontMap[font] || "'Inter', sans-serif";
                root.style.setProperty('--font-family', newFontFamily);
                localStorage.setItem('sgap_theme_font', font);
                dom.themeFontSelect.value = font;
            }

            if(state.isAuthReady) renderDashboard();
        }

        function adjustFontSize(delta) {
            const root = document.documentElement;
            let currentSize = parseFloat(getComputedStyle(root).fontSize);
            let newSize = Math.max(12, Math.min(18, currentSize + delta)); 
            root.style.fontSize = `${newSize}px`;
            localStorage.setItem('sgap_theme_fontsize', `${newSize}px`);
        }
        
        function resetTheme() {
            localStorage.removeItem('sgap_theme_name');
            localStorage.removeItem('sgap_theme_custom_color');
            localStorage.removeItem('sgap_theme_font');
            localStorage.removeItem('sgap_theme_fontsize');
            
            document.documentElement.style.fontSize = '15px';
            applyTheme('sereno', 'Inter'); 
        }

        function applyThemeFromLocalStorage() {
            const themeName = localStorage.getItem('sgap_theme_name') || 'sereno';
            const font = localStorage.getItem('sgap_theme_font') || 'Inter';
            const fontSize = localStorage.getItem('sgap_theme_fontsize') || '15px';
            
            document.documentElement.style.fontSize = fontSize;
            
            let customColor = null;
            if (themeName === 'custom') {
                customColor = localStorage.getItem('sgap_theme_custom_color') || '#648AAE';
            }
            
            applyTheme(themeName, font, customColor);
        }
        
        function loadStateFromLocalStorage() {
            const savedMainView = localStorage.getItem('sgap_currentMainView');
            if (savedMainView) state.currentMainView = savedMainView;
            
            const savedPautasView = localStorage.getItem('sgap_currentPautasView');
            if (savedPautasView) state.currentPautasView = savedPautasView;

            const savedAdminView = localStorage.getItem('sgap_currentAdminView');
            if (savedAdminView) state.currentAdminView = savedAdminView;
            
            const savedPeriodo = localStorage.getItem('sgap_filterPeriodo');
            if (savedPeriodo) state.filterPeriodo = savedPeriodo;

            const savedFunc = localStorage.getItem('sgap_filterFuncionario');
            if (savedFunc) state.filterFuncionario = savedFunc;

            const savedCargo = localStorage.getItem('sgap_filterCargo');
            if (savedCargo) state.filterCargo = savedCargo;

            const savedCliente = localStorage.getItem('sgap_filterCliente');
            if (savedCliente) state.filterCliente = savedCliente;

            const savedTarefa = localStorage.getItem('sgap_filterTarefa');
            if (savedTarefa) state.filterTarefa = savedTarefa;
            
            const savedSidebarState = localStorage.getItem('sgap_sidebarMinimized');
            state.isSidebarMinimized = (savedSidebarState === 'true');
            applySidebarState();
            
            if (dom.menuPautas) dom.menuPautas.classList.toggle('menu-btn-active', state.currentMainView === 'pautas');
            if (dom.menuDashboard) dom.menuDashboard.classList.toggle('menu-btn-active', state.currentMainView === 'dashboard');
            if (dom.menuAdmin) dom.menuAdmin.classList.toggle('menu-btn-active', state.currentMainView === 'admin');

            if (dom.pautasNav) {
                Array.from(dom.pautasNav.querySelectorAll('button[data-view]')).forEach(btn => {
                    btn.classList.toggle('sub-nav-btn-active', btn.dataset.view === state.currentPautasView);
                    btn.classList.toggle('sub-nav-btn-inactive', btn.dataset.view !== state.currentPautasView);
                });
            }
            if (dom.adminNav) {
                 Array.from(dom.adminNav.querySelectorAll('button[data-view]')).forEach(btn => {
                    btn.classList.toggle('sub-nav-btn-active', btn.dataset.view === state.currentAdminView);
                    btn.classList.toggle('sub-nav-btn-inactive', btn.dataset.view !== state.currentAdminView);
                });
            }
        }

        // --- Funções do Menu Lateral ---
        function toggleSidebar() {
            state.isSidebarMinimized = !state.isSidebarMinimized;
            localStorage.setItem('sgap_sidebarMinimized', state.isSidebarMinimized);
            applySidebarState();
        }
        
        function applySidebarState() {
            const isMinimized = state.isSidebarMinimized;
            const menu = dom.sidebarMenu;
            const main = dom.mainContentWrapper;
            const toggleBtn = dom.sidebarToggleButton;
            const title = dom.sidebarTitle;

            if (!menu || !main || !toggleBtn || !title) return; // Proteção

            document.body.classList.toggle('sidebar-minimized', isMinimized);

            menu.classList.toggle('w-64', !isMinimized);
            menu.classList.toggle('w-20', isMinimized); 

            main.classList.toggle('md:ml-64', !isMinimized);
            main.classList.toggle('md:ml-20', isMinimized);

            menu.querySelectorAll('.sidebar-text').forEach(text => {
                text.classList.toggle('hidden', isMinimized);
            });
            menu.querySelectorAll('.sidebar-nav-icon').forEach(icon => {
                icon.classList.toggle('hidden', !isMinimized);
            });
            
            title.classList.toggle('hidden', isMinimized);

            menu.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.toggle('justify-center', isMinimized);
                btn.classList.toggle('justify-start', !isMinimized);
            });
            
            if (dom.userIdDisplayWrapper) {
                dom.userIdDisplayWrapper.classList.toggle('justify-center', isMinimized);
                dom.userIdDisplayWrapper.classList.toggle('justify-start', !isMinimized);
            }
            
            if (toggleBtn) {
                const icon = toggleBtn.querySelector('svg');
                if (isMinimized) {
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>';
                } else {
                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>';
                }
            }
        }

        // --- Troca de Views ---
        function switchMainView(view) {
            if (view === 'admin' && state.userRole !== 'admin') {
                showToast("Apenas 'admins' podem aceder a esta área.", "error");
                return;
            }
            
            state.currentMainView = view;
            
            dom.menuPautas.classList.toggle('menu-btn-active', view === 'pautas');
            dom.menuDashboard.classList.toggle('menu-btn-active', view === 'dashboard');
            dom.menuAdmin.classList.toggle('menu-btn-active', view === 'admin');

            dom.mainViewPautas.classList.toggle('hidden', view !== 'pautas');
            dom.mainViewDashboard.classList.toggle('hidden', view !== 'dashboard');
            dom.mainViewAdmin.classList.toggle('hidden', view !== 'admin');
            
            render();
            localStorage.setItem('sgap_currentMainView', view); 
        }

        function switchPautasView(view) {
            state.currentPautasView = view;
            Array.from(dom.pautasNav.querySelectorAll('button[data-view]')).forEach(btn => {
                btn.classList.toggle('sub-nav-btn-active', btn.dataset.view === view);
                btn.classList.toggle('sub-nav-btn-inactive', btn.dataset.view !== view);
            });
            renderPautas();
            localStorage.setItem('sgap_currentPautasView', view); 
        }

        function switchAdminView(view) {
            state.currentAdminView = view;
             Array.from(dom.adminNav.querySelectorAll('button[data-view]')).forEach(btn => {
                btn.classList.toggle('sub-nav-btn-active', btn.dataset.view === view);
                btn.classList.toggle('sub-nav-btn-inactive', btn.dataset.view !== view);
            });
            renderAdmin();
            localStorage.setItem('sgap_currentAdminView', view); 
        }

        // --- Renderização Principal ---
        function render() {
            if (!state.isAuthReady) return;

            renderFiltros(); 

            if (state.currentMainView === 'pautas') {
                renderPautas();
            } else if (state.currentMainView === 'dashboard') {
                renderDashboard();
            } else if (state.currentMainView === 'admin') {
                renderAdmin();
            }
            
            updateUIVisibility();
        }
        
        function updateUIVisibility() {
            const canEdit = (state.userRole === 'admin' || state.userRole === 'editor');
            const isAdmin = (state.userRole === 'admin');
            
            if(dom.btnLancarAtividadeMenu) dom.btnLancarAtividadeMenu.classList.toggle('hidden', !canEdit);
            if(dom.menuAdmin) dom.menuAdmin.classList.toggle('hidden', !isAdmin); 
            
            // Filtros Globais visíveis para Pautas e Dashboard
            if(dom.filtrosGlobaisContainer) {
                const isFiltroHidden = (state.currentMainView === 'admin');
                dom.filtrosGlobaisContainer.classList.toggle('hidden', isFiltroHidden);
            }
            
            if(!isAdmin && state.currentMainView === 'admin') {
                switchMainView('pautas');
            }
        }
        
        function renderAdmin() {
            if (!dom.adminContent || state.userRole !== 'admin') return; 
            
            if (state.currentAdminView === 'funcionarios') {
                renderAdminFuncionarios();
            } else if (state.currentAdminView === 'cargos') {
                renderAdminCargos();
            } else if (state.currentAdminView === 'clientes') {
                renderAdminClientes();
            } else if (state.currentAdminView === 'tarefas') {
                renderAdminTarefas();
            } else if (state.currentAdminView === 'usuarios') {
                renderAdminUsuarios();
            } else if (state.currentAdminView === 'todas-pautas') {
                renderAdminTodasPautas(); // Adicionado
            } else if (state.currentAdminView === 'personalizacao') {
                renderAdminPersonalizacao();
            }
        }

        // --- Funções de Renderização de Pautas ---

        function renderFiltros() {
            if (!dom.filterFuncionario) return; 

            const selPeriodo = state.filterPeriodo;
            const selFunc = state.filterFuncionario;
            const selCargo = state.filterCargo;
            const selCliente = state.filterCliente;
            const selTarefa = state.filterTarefa;
            
            let funcOptions = '<option value="todos">Todos Funcionários</option>';
            state.funcionarios.forEach(f => {
                funcOptions += `<option value="${f.id}">${f.nome}</option>`;
            });
            dom.filterFuncionario.innerHTML = funcOptions;
            
            let cargoOptions = '<option value="todos">Todos Cargos</option>';
            state.cargos.forEach(c => {
                cargoOptions += `<option value="${c.id}">${c.nome}</option>`;
            });
            dom.filterCargo.innerHTML = cargoOptions;
            
            let clienteOptions = '<option value="todos">Todos Clientes</option>';
            state.clientes.forEach(c => {
                clienteOptions += `<option value="${c.id}">${c.nome}</option>`;
            });
            dom.filterCliente.innerHTML = clienteOptions;
            
            let tarefaOptions = '<option value="todos">Todas Tarefas</option>';
            state.tarefasPadrao.forEach(t => {
                tarefaOptions += `<option value="${t.nome}">${t.nome}</option>`;
            });
            dom.filterTarefa.innerHTML = tarefaOptions;

            if(dom.filterPeriodo) dom.filterPeriodo.value = selPeriodo;
            if(dom.filterFuncionario) dom.filterFuncionario.value = selFunc;
            if(dom.filterCargo) dom.filterCargo.value = selCargo;
            if(dom.filterCliente) dom.filterCliente.value = selCliente;
            if(dom.filterTarefa) dom.filterTarefa.value = selTarefa;
        }

        function getFilteredAtividades(ignoreFilters = []) { 
            let agora = new Date(); 
            let atividadesFiltradas = state.atividades;
        
            if (state.currentPautasView === 'lista' || state.currentMainView === 'dashboard' || (state.currentPautasView === 'calendario' && !ignoreFilters.includes('periodo'))) {
                if (state.filterPeriodo === 'hoje') {
                    const hojeStr = agora.toISOString().split('T')[0];
                    atividadesFiltradas = atividadesFiltradas.filter(at => {
                        if (!at.data) return false;
                        return at.data === hojeStr;
                    });
                } else if (state.filterPeriodo === 'semana') {
                    const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                    const diaDaSemana = hoje.getDay(); 
                    
                    const inicioSemana = new Date(hoje.getTime());
                    inicioSemana.setDate(hoje.getDate() - diaDaSemana);
                    inicioSemana.setHours(0, 0, 0, 0); 
    
                    const fimSemana = new Date(inicioSemana.getTime());
                    fimSemana.setDate(inicioSemana.getDate() + 6);
                    fimSemana.setHours(23, 59, 59, 999); 
    
                    atividadesFiltradas = atividadesFiltradas.filter(at => {
                        if (!at.data) return false;
                        const dataAt = new Date(at.data + 'T12:00:00'); 
                        return dataAt >= inicioSemana && dataAt <= fimSemana;
                    });
                } else if (state.filterPeriodo === 'mes') { // Adicionado
                    const mesAtual = agora.getMonth();
                    const anoAtual = agora.getFullYear();
                    atividadesFiltradas = atividadesFiltradas.filter(at => {
                        if (!at.data) return false;
                        const dataAt = new Date(at.data + 'T12:00:00');
                        return dataAt.getMonth() === mesAtual && dataAt.getFullYear() === anoAtual;
                    });
                } 
            }

            if (state.filterCargo !== 'todos') {
                let funcionariosFiltradosPorCargo = [];
                funcionariosFiltradosPorCargo = state.funcionarios
                    .filter(f => f.cargoId === state.filterCargo)
                    .map(f => f.id);
                    
                atividadesFiltradas = atividadesFiltradas.filter(at => 
                    funcionariosFiltradosPorCargo.includes(at.funcionarioId)
                );
            }
            
            if (state.filterFuncionario !== 'todos') {
                atividadesFiltradas = atividadesFiltradas.filter(at => 
                    at.funcionarioId === state.filterFuncionario
                );
            }
            
            if (!ignoreFilters.includes('cliente') && state.filterCliente !== 'todos') {
                atividadesFiltradas = atividadesFiltradas.filter(at => 
                    at.clienteId === state.filterCliente
                );
            }

            if (!ignoreFilters.includes('tarefa') && state.filterTarefa !== 'todos') {
                atividadesFiltradas = atividadesFiltradas.filter(at => 
                    at.titulo === state.filterTarefa
                );
            }
            
            return atividadesFiltradas;
        }
        
        // --- Função Utilitária para Cores de Status ---
        function getStatusCardClasses(status) {
            // Define os mapeamentos de cores (classes CSS)
            const statusMap = {
                'Concluído': 'status-concluido',
                'Em Andamento': 'status-em-andamento',
                'Pendente': 'status-pendente',
                'Bloqueado': 'status-bloqueado',
                'default': 'status-default'
            };
            
            return statusMap[status] || statusMap['default'];
        }

        function renderPautas() {
            if (!dom.pautasContent) return;
            if (state.currentPautasView === 'calendario') {
                renderCalendario();
            } else if (state.currentPautasView === 'semana') {
                renderSemana();
            } else if (state.currentPautasView === 'lista') {
                renderLista();
            }
        }

        function renderCalendario() {
            const month = state.currentDate.getMonth();
            const year = state.currentDate.getFullYear();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const monthName = state.currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            
            const atividadesFiltradas = getFilteredAtividades([], true); // Ignora período
            const atividadesDoMes = atividadesFiltradas.filter(at => {
                if (!at.data) return false;
                const dataAt = new Date(at.data + 'T12:00:00');
                return dataAt.getMonth() === month && dataAt.getFullYear() === year;
            });
            
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
            
            let html = `<div class="p-4 bg-[var(--color-card)] rounded-lg shadow-sm">`;
            html += `<div class="flex justify-between items-center mb-4">
                <button data-action="prev-month" class="btn-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button data-action="today" class="btn-secondary">Hoje</button>
                <h2 class="text-xl font-semibold capitalize">${monthName}</h2>
                <button data-action="next-month" class="btn-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>`;
            
            html += `<div class="grid grid-cols-7 gap-1 text-center font-bold">`;
            diasSemana.forEach(dia => html += `<div class="p-2 bg-[var(--color-bg-alt)] rounded-md text-sm text-[var(--color-text-secondary)]">${dia}</div>`);
            html += `</div>`;
            
            html += `<div class="grid grid-cols-7 gap-1 mt-1">`;
            
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="border rounded-md bg-stone-50 min-h-[100px]"></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const diaAtual = new Date(year, month, day);
                const hoje = new Date();
                const isHoje = diaAtual.toDateString() === hoje.toDateString();
                
                const atividadesDoDia = atividadesDoMes.filter(at => {
                    const dataAt = new Date(at.data + 'T12:00:00');
                    return dataAt.getDate() === day;
                });
                
                html += `<div class="${isHoje ? 'bg-[var(--color-accent-light)]' : 'bg-[var(--color-card)]'} border rounded-md min-h-[120px] p-1.5 flex flex-col">`;
                html += `<span class="font-semibold ${isHoje ? 'text-[var(--color-accent-dark)]' : 'text-[var(--color-text-primary)]'}">${day}</span>`;
                html += `<div class="flex-grow overflow-y-auto space-y-0.5 mt-1">`;
                
                atividadesDoDia.forEach(at => {
                    const func = state.funcionarios.find(f => f.id === at.funcionarioId);
                    const cliente = state.clientes.find(c => c.id === at.clienteId);
                    const statusClasses = getStatusCardClasses(at.status || 'Pendente'); 
                    
                    html += `
                        <div class="status-card-base ${statusClasses}"
                             data-action="edit" data-id="${at.id}">
                            <strong class="block truncate">${at.titulo}</strong>
                            <span class="block opacity-80 truncate">${func ? func.nome : '...'}</span>
                            <span class="block opacity-60 truncate">${cliente ? cliente.nome : 'Sem Cliente'}</span>
                        </div>`;
                });
                
                html += `</div></div>`;
            }
            html += `</div></div>`;
            
            dom.pautasContent.innerHTML = html;
        }

        function renderSemana() {
            const diasSemanaLabels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
            const diasDaSemanaArray = [];
            const hoje = new Date();
            const hojeKey = hoje.toISOString().split('T')[0];

            const diaDaSemanaAtual = state.currentDate.getDay(); 
            const inicioSemana = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), state.currentDate.getDate() - diaDaSemanaAtual);
            inicioSemana.setHours(0, 0, 0, 0);

            const fimSemana = new Date(inicioSemana.getTime());
            fimSemana.setDate(inicioSemana.getDate() + 6);
            fimSemana.setHours(23, 59, 59, 999);
            
            const getKey = (date) => date.toISOString().split('T')[0];
            
            for (let i = 0; i < 7; i++) {
                const diaAtual = new Date(inicioSemana.getTime());
                diaAtual.setDate(inicioSemana.getDate() + i);
                
                diasDaSemanaArray.push({
                    key: getKey(diaAtual),
                    label: diasSemanaLabels[i],
                    dayNum: diaAtual.getDate(),
                    monthNum: diaAtual.getMonth() + 1,
                    isHoje: getKey(diaAtual) === hojeKey,
                });
            }

            const atividadesFiltradas = getFilteredAtividades([], true); // Ignora período
            const atividadesDaSemana = atividadesFiltradas.filter(at => {
                if (!at.data) return false;
                const dataAt = new Date(at.data + 'T12:00:00');
                return dataAt >= inicioSemana && dataAt <= fimSemana;
            });

            let funcionariosParaExibir = [...state.funcionarios];
            if (state.filterCargo !== 'todos') {
                funcionariosParaExibir = funcionariosParaExibir.filter(f => f.cargoId === state.filterCargo);
            }
            if (state.filterFuncionario !== 'todos') {
                funcionariosParaExibir = funcionariosParaExibir.filter(f => f.id === state.filterFuncionario);
            }
            
            const formatOptions = { day: 'numeric', month: 'short' };
            const inicioStr = inicioSemana.toLocaleDateString('pt-BR', formatOptions);
            const fimStr = fimSemana.toLocaleDateString('pt-BR', formatOptions);
            const anoStr = inicioSemana.getFullYear();

            let html = `<div class="bg-[var(--color-card)] rounded-lg shadow-sm">`;
            html += `<div class="flex justify-between items-center mb-4 p-4 border-b">
                <button data-action="prev-week" class="btn-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button data-action="today" class="btn-secondary">Hoje</button>
                <h2 class="text-xl font-semibold capitalize text-center">${inicioStr} - ${fimStr}, ${anoStr}</h2>
                <button data-action="next-week" class="btn-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>`;

            html += `<div class="overflow-x-auto">`;
            html += `<div class="grid min-w-[1200px]" style="grid-template-columns: 180px repeat(7, minmax(140px, 1fr));">`;
            
            html += `<div class="p-2 font-bold bg-[var(--color-bg-alt)] border-b border-r border-stone-200 sticky top-0 left-0 z-20">Funcionário</div>`;
            diasDaSemanaArray.forEach(dia => {
                html += `<div class="p-2 font-bold text-center ${dia.isHoje ? 'bg-[var(--color-accent-light)] text-[var(--color-accent-dark)]' : 'bg-[var(--color-bg-alt)]'} border-b border-r border-stone-200 sticky top-0 z-10">
                    ${dia.label}
                    <span class="block text-lg font-bold ${dia.isHoje ? 'text-[var(--color-accent-darker)]' : 'text-[var(--color-text-primary)]'}">${dia.dayNum}/${String(dia.monthNum).padStart(2, '0')}</span>
                </div>`;
            });

            if (funcionariosParaExibir.length === 0) {
                 html += `<div class="col-span-8 p-10 text-center text-stone-500">
                    Nenhum funcionário encontrado para os filtros selecionados.
                 </div>`;
            }

            funcionariosParaExibir.forEach(func => {
                html += `<div class="p-2 border-b border-r border-stone-200 sticky left-0 bg-[var(--color-card)] z-10 flex flex-col items-center justify-center">
                    <img src="${func.fotoUrl || 'https://placehold.co/60x60/E0E8F0/4A698E?text=?'}" alt="Foto de ${func.nome}" class="w-12 h-12 rounded-full object-cover mb-1">
                    <span class="text-sm font-medium text-center truncate w-full">${func.nome}</span>
                </div>`;
                
                diasDaSemanaArray.forEach(dia => {
                    const cellAtividades = atividadesDaSemana.filter(at => 
                        at.funcionarioId === func.id && at.data === dia.key
                    );
                    
                    html += `<div class="${dia.isHoje ? 'bg-stone-50' : 'bg-[var(--color-card)]'} border-b border-r border-stone-200 min-h-[100px] p-1.5 flex flex-col">`;
                    html += `<div class="flex-grow overflow-y-auto space-y-0.5 mt-1 pr-1">`;

                    cellAtividades.forEach(at => {
                        const cliente = state.clientes.find(c => c.id === at.clienteId);
                        const statusClasses = getStatusCardClasses(at.status || 'Pendente'); 
                        
                        html += `
                            <div class="status-card-base ${statusClasses}"
                                 data-action="edit" data-id="${at.id}">
                                <strong class="block truncate">${at.titulo}</strong>
                                <span class="block opacity-60 truncate">${cliente ? cliente.nome : 'Sem Cliente'}</span>
                            </div>`;
                    });

                    html += `</div></div>`;
                });
            });

            html += `</div></div></div>`; 
            
            dom.pautasContent.innerHTML = html;
        }

        function renderLista(targetElement = dom.pautasContent) { 
            const atividades = getFilteredAtividades(['cliente', 'tarefa']);
            
            const tarefasParaExibir = [...state.tarefasPadrao].sort((a, b) => a.nome.localeCompare(b.nome));
            const clientesParaExibir = [...state.clientes].sort((a, b) => a.nome.localeCompare(b.nome));

            let html = `<div class="bg-[var(--color-card)] rounded-lg shadow-sm">`;
            html += `<div class="p-4 border-b">
                <h2 class="text-xl font-semibold text-stone-700">Matriz de Atividades</h2>
                <p class="text-sm text-stone-600">Visão geral de tarefas por cliente. (Filtros de Período, Funcionário e Cargo estão aplicados).</p>
            </div>`;
            
            html += `<div class="overflow-x-auto">`;
            html += `<div class="grid min-w-[1200px]" style="grid-template-columns: 180px repeat(${tarefasParaExibir.length}, minmax(140px, 1fr));">`;

            html += `<div class="p-2 font-bold bg-[var(--color-bg-alt)] border-b border-r border-stone-200 sticky top-0 left-0 z-20">Cliente / Tarefa</div>`;
            tarefasParaExibir.forEach(tarefa => {
                html += `<div class="p-2 font-bold text-center bg-[var(--color-bg-alt)] border-b border-r border-stone-200 sticky top-0 z-10" title="${tarefa.nome}">
                    <span class="truncate block">${tarefa.nome}</span>
                </div>`;
            });
            
            if (clientesParaExibir.length === 0) {
                 html += `<div class="col-span-${tarefasParaExibir.length + 1} p-10 text-center text-stone-500">
                    Nenhum cliente cadastrado.
                 </div>`;
            } else if (tarefasParaExibir.length === 0) {
                 html += `<div class="col-span-1 p-10 text-center text-stone-500">
                    Nenhuma tarefa padrão cadastrada.
                 </div>`;
            }

            clientesParaExibir.forEach(cliente => {
                html += `<div class="p-2 border-b border-r border-stone-200 sticky left-0 bg-[var(--color-card)] z-10 flex flex-col items-start justify-center">
                    <span class="text-sm font-medium text-stone-800 text-left truncate w-full">${cliente.nome}</span>
                </div>`;
                
                tarefasParaExibir.forEach(tarefa => {
                    const cellAtividades = atividades.filter(at => 
                        at.clienteId === cliente.id && at.titulo === tarefa.nome
                    );
                    
                    html += `<div class="bg-[var(--color-card)] border-b border-r border-stone-200 min-h-[100px] p-1.5 flex flex-col">`;
                    html += `<div class="flex-grow overflow-y-auto space-y-0.5 mt-1 pr-1">`;

                    cellAtividades.forEach(at => {
                        const func = state.funcionarios.find(f => f.id === at.funcionarioId);
                        const statusClasses = getStatusCardClasses(at.status || 'Pendente'); 
                        const dataFormatada = new Date(at.data + 'T12:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                        
                        html += `
                            <div class="relative status-card-base ${statusClasses}"
                                 data-action="edit" data-id="${at.id}">
                                
                                <button data-action="delete" data-id="${at.id}" class="absolute top-0 right-0 p-0.5 text-red-500 hover:text-red-800 opacity-50 hover:opacity-100">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                                
                                <strong class="block truncate pr-3">${func ? func.nome : 'N/A'}</strong> 
                                <span class="block opacity-80 truncate">${dataFormatada}</span>
                                <span class="block opacity-80 truncate">${at.status || 'Pendente'}</span>
                            </div>`;
                    });

                    html += `</div></div>`; 
                });
            });

            html += `</div></div></div>`; 
            
            targetElement.innerHTML = html; 
        }

        // --- Fim das Funções de Pautas ---

        function renderDashboard(targetElement = dom.dashboardContent) { 
            if (!targetElement || (state.currentMainView !== 'dashboard' && state.currentMainView !== 'visual-equipe')) return;

            const atividades = getFilteredAtividades(); 
            const totalAtividades = atividades.length;

            const statusCounts = { 'Pendente': 0, 'Em Andamento': 0, 'Concluído': 0, 'Bloqueado': 0 };
            
            atividades.forEach(at => {
                const status = at.status || 'Pendente';
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }
            });
            const statusLabels = Object.keys(statusCounts);
            const statusData = Object.values(statusCounts);
            
            const totalConcluidas = statusCounts['Concluído'];
            const totalPendentes = statusCounts['Pendente'];
            
            const statusColors = {
                'Pendente': 'var(--color-status-pendente)',
                'Em Andamento': 'var(--color-status-em-andamento)',
                'Concluído': 'var(--color-status-concluido)', 
                'Bloqueado': 'var(--color-status-bloqueado)'
            };
            
            const clientesDoPeriodo = new Set(atividades.map(at => at.clienteId));
            const totalClientesPeriodo = clientesDoPeriodo.size;
            
            const clientesNaSelecao = [...clientesDoPeriodo];
            let clientes100Percent = 0;
            clientesNaSelecao.forEach(clienteId => {
                const atividadesDoCliente = atividades.filter(at => at.clienteId === clienteId);
                const concluidasDoCliente = atividadesDoCliente.filter(at => at.status === 'Concluído');
                if (atividadesDoCliente.length > 0 && atividadesDoCliente.length === concluidasDoCliente.length) {
                    clientes100Percent++;
                }
            });

            const percentagemConcluidas = totalAtividades > 0 ? (totalConcluidas / totalAtividades) * 100 : 0;
            const percentagemRestante = 100 - percentagemConcluidas;

            const tarefaProgress = [];
            state.tarefasPadrao.forEach(tarefa => {
                const taskName = tarefa.nome;
                let totalParaTarefa = 0;
                let concluidasParaTarefa = 0;

                atividades.forEach(at => {
                    if (at.titulo === taskName) {
                        totalParaTarefa++;
                        if (at.status === 'Concluído') {
                            concluidasParaTarefa++;
                        }
                    }
                });

                const percentage = (totalParaTarefa === 0) ? 0 : Math.round((concluidasParaTarefa / totalParaTarefa) * 100);
                
                tarefaProgress.push({
                    nome: taskName,
                    percentage: percentage,
                    total: totalParaTarefa,
                    concluidas: concluidasParaTarefa
                });
            });


            targetElement.innerHTML = ` 
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                    <!-- Coluna 1: KPIs Principais -->
                    <div class="bg-[var(--color-card)] p-6 rounded-lg shadow-sm space-y-6">
                        <div>
                            <h3 class="text-lg font-medium text-stone-600 mb-2">Pauta Geral (Concluídas)</h3>
                            <div class="relative max-w-[200px] mx-auto">
                                <canvas id="pautaDoughnutChart"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <span class="text-3xl font-bold text-[var(--color-status-concluido-dark)]">${Math.round(percentagemConcluidas)}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-medium text-stone-600 mb-4">Resumo do Período</h3>
                            <div class="space-y-3">
                                <div class="kpi-card">
                                    <span class="text-sm text-stone-600">Total de Demandas</span>
                                    <span class="text-2xl font-semibold text-stone-800">${totalAtividades}</span>
                                </div>
                                <div class="kpi-card">
                                    <span class="text-sm text-stone-600">Demandas Concluídas</span>
                                    <span class="text-2xl font-semibold" style="color: var(--color-status-concluido-dark);">${totalConcluidas}</span>
                                </div>
                                <div class="kpi-card">
                                    <span class="text-sm text-stone-600">Demandas Pendentes</span>
                                    <span class="text-2xl font-semibold" style="color: var(--color-status-pendente-dark);">${totalPendentes}</span>
                                </div>
                                <div class="kpi-card">
                                    <span class="text-sm text-stone-600">Clientes 100% Concluídos</span>
                                    <span class="text-2xl font-semibold text-stone-800">${clientes100Percent}</span>
                                </div>
                                <div class="kpi-card">
                                    <span class="text-sm text-stone-600">Clientes Ativos (no período)</span>
                                    <span class="text-2xl font-semibold text-stone-800">${totalClientesPeriodo}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Coluna 2: Status por Etapa -->
                    <div class="bg-[var(--color-card)] p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold mb-4 text-stone-700">Status por Etapa</h2>
                        <p class="mb-4 text-stone-600">Total de atividades (com filtros): <strong>${totalAtividades}</strong></p>
                        
                        <div class="relative max-w-[280px] mx-auto">
                            <canvas id="statusPieChart"></canvas>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-medium text-stone-600 mb-3 text-center">Checks por Setor</h3>
                            <ul class="space-y-2">
                                <li class="flex justify-between items-center text-sm">
                                    <span class="flex items-center">
                                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--color-status-concluido);"></span>
                                        Concluído
                                    </span>
                                    <span class="font-semibold">${statusCounts['Concluído']}</span>
                                </li>
                                <li class="flex justify-between items-center text-sm">
                                    <span class="flex items-center">
                                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--color-status-pendente);"></span>
                                        Pendente
                                    </span>
                                    <span class="font-semibold">${statusCounts['Pendente']}</span>
                                </li>
                                <li class="flex justify-between items-center text-sm">
                                    <span class="flex items-center">
                                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--color-status-em-andamento);"></span>
                                        Em Andamento
                                    </span>
                                    <span class="font-semibold">${statusCounts['Em Andamento']}</span>
                                </li>
                                <li class="flex justify-between items-center text-sm">
                                    <span class="flex items-center">
                                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: var(--color-status-bloqueado);"></span>
                                        Bloqueado
                                    </span>
                                    <span class="font-semibold">${statusCounts['Bloqueado']}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Coluna 3: Progresso por Tarefa Padrão -->
                    <div class="bg-[var(--color-card)] p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold mb-4 text-stone-700">Progresso por Tarefa Padrão</h2>
                        <p class="mb-4 text-stone-600">Percentagem de atividades concluídas para cada tarefa (com filtros).</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-6 overflow-y-auto max-h-[500px] pr-2">
                            ${tarefaProgress.length > 0 ? tarefaProgress.map(task => {
                                const gradient = `conic-gradient(var(--color-status-concluido) ${task.percentage}%, #e5e7eb ${task.percentage}% 100%)`;
                                
                                return `
                                <div class="flex flex-col items-center">
                                    <div class="relative w-24 h-24 rounded-full flex items-center justify-center" style="background: ${gradient};">
                                        <div class="w-20 h-20 bg-[var(--color-card)] rounded-full flex items-center justify-center shadow-inner">
                                            <span class="text-xl font-bold text-[var(--color-status-concluido-dark)]">${task.percentage}%</span>
                                        </div>
                                    </div>
                                    <span class="mt-2 text-sm font-medium text-stone-700 text-center truncate w-full" title="${task.nome}">${task.nome}</span>
                                    <span class="text-xs text-stone-500">${task.concluidas} / ${task.total} ativ.</span>
                                </div>
                                `;
                            }).join('') : '<p class="text-stone-500 col-span-full text-center">Nenhuma tarefa padrão encontrada com atividades nos filtros atuais.</p>'}
                        </div>
                    </div>
                </div>`;

            const rootStyle = getComputedStyle(document.documentElement);
            Chart.defaults.font.family = rootStyle.getPropertyValue('--font-family') || "'Inter', sans-serif";
            Chart.defaults.font.size = 12;
            Chart.defaults.color = rootStyle.getPropertyValue('--color-text-primary') || '#1f2937';

            const ctxPie = targetElement.querySelector('#statusPieChart')?.getContext('2d'); 
            if (state.dashboardChart) state.dashboardChart.destroy(); 
            
            if (ctxPie) {
                state.dashboardChart = new Chart(ctxPie, {
                    type: 'pie',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusData,
                            backgroundColor: [
                                statusColors['Pendente'],
                                statusColors['Em Andamento'],
                                statusColors['Concluído'],
                                statusColors['Bloqueado']
                            ],
                            borderColor: 'var(--color-card)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const percentage = totalAtividades > 0 ? (value / totalAtividades * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            const ctxDoughnut = targetElement.querySelector('#pautaDoughnutChart')?.getContext('2d'); 
            if (state.dashboardDoughnutChart) state.dashboardDoughnutChart.destroy(); 
            
            if (ctxDoughnut) {
                state.dashboardDoughnutChart = new Chart(ctxDoughnut, {
                    type: 'doughnut',
                    data: {
                        labels: ['Concluído', 'Restante'],
                        datasets: [{
                            data: [percentagemConcluidas, percentagemRestante],
                            backgroundColor: [
                                'var(--color-status-concluido)', 
                                '#e5e7eb'  
                            ],
                            borderColor: '#E5E7EB', // Cinza claro
                            borderWidth: 2,
                            hoverBorderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '75%', 
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                enabled: true,
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        return ` ${label}: ${value.toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }


        function renderAdminFuncionarios() {
            let html = `<div class="flex justify-end mb-4">
                <button data-action="add" class="btn-primary">
                    Adicionar Funcionário
                </button>
            </div>`;
            
            html += `<div class="overflow-x-auto bg-[var(--color-card)] rounded-lg shadow-sm">
                <table class="min-w-full divide-y divide-stone-200">
                    <thead class="bg-[var(--color-bg-alt)]">
                        <tr>
                            <th class="table-header">Nome</th>
                            <th class="table-header">Foto</th>
                            <th class="table-header">Email</th>
                            <th class="table-header">Cargo</th>
                            <th class="table-header text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-[var(--color-card)] divide-y divide-stone-200">`;

            if (state.funcionarios.length === 0) {
                html += `<tr><td colspan="5" class="px-6 py-4 text-center text-stone-500">Nenhum funcionário cadastrado.</td></tr>`;
            }

            state.funcionarios.forEach(func => {
                const cargo = state.cargos.find(c => c.id === func.cargoId);
                html += `
                    <tr>
                        <td class="table-cell font-medium text-stone-900">${func.nome}</td>
                        <td class="table-cell">
                            <img src="${func.fotoUrl || 'https://placehold.co/40x40/E0E8F0/4A698E?text=?'}" alt="Foto de ${func.nome}" class="w-10 h-10 rounded-full object-cover">
                        </td>
                        <td class="table-cell">${func.email || 'N/A'}</td>
                        <td class="table-cell">${cargo ? cargo.nome : 'Sem cargo'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-action="edit" data-id="${func.id}" class="btn-link">Editar</button>
                            <button data-action="delete" data-id="${func.id}" class="btn-link-danger">Excluir</button>
                        </td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
            dom.adminContent.innerHTML = html;
        }

        function renderAdminCargos() {
            let html = `<div class="flex justify-end mb-4">
                <button data-action="add" class="btn-primary">
                    Adicionar Cargo
                </button>
            </div>`;
            
            html += `<div class="overflow-x-auto bg-[var(--color-card)] rounded-lg shadow-sm">
                <table class="min-w-full divide-y divide-stone-200">
                    <thead class="bg-[var(--color-bg-alt)]">
                        <tr>
                            <th class="table-header">Nome do Cargo</th>
                            <th class="table-header text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-[var(--color-card)] divide-y divide-stone-200">`;

            if (state.cargos.length === 0) {
                html += `<tr><td colspan="2" class="px-6 py-4 text-center text-stone-500">Nenhum cargo cadastrado.</td></tr>`;
            }

            state.cargos.forEach(cargo => {
                html += `
                    <tr>
                        <td class="table-cell font-medium text-stone-900">${cargo.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-action="edit" data-id="${cargo.id}" class="btn-link">Editar</button>
                            <button data-action="delete" data-id="${cargo.id}" class="btn-link-danger">Excluir</button>
                        </td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
            dom.adminContent.innerHTML = html;
        }
        
        function renderAdminClientes() {
            let html = `<div class="flex justify-end mb-4">
                <button data-action="add" class="btn-primary">
                    Adicionar Cliente
                </button>
            </div>`;
            
            html += `<div class="overflow-x-auto bg-[var(--color-card)] rounded-lg shadow-sm">
                <table class="min-w-full divide-y divide-stone-200">
                    <thead class="bg-[var(--color-bg-alt)]">
                        <tr>
                            <th class="table-header">Nome do Cliente</th>
                            <th class="table-header text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-[var(--color-card)] divide-y divide-stone-200">`;

            if (state.clientes.length === 0) {
                html += `<tr><td colspan="2" class="px-6 py-4 text-center text-stone-500">Nenhum cliente cadastrado.</td></tr>`;
            }

            state.clientes.forEach(cliente => {
                html += `
                    <tr>
                        <td class="table-cell font-medium text-stone-900">${cliente.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-action="edit" data-id="${cliente.id}" class="btn-link">Editar</button>
                            <button data-action="delete" data-id="${cliente.id}" class="btn-link-danger">Excluir</button>
                        </td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
            dom.adminContent.innerHTML = html;
        }
        
        function renderAdminTarefas() {
            let html = `<div class="flex justify-end mb-4">
                <button data-action="add" class="btn-primary">
                    Adicionar Tarefa
                </button>
            </div>`;
            
            html += `<div class="overflow-x-auto bg-[var(--color-card)] rounded-lg shadow-sm">
                <table class="min-w-full divide-y divide-stone-200">
                    <thead class="bg-[var(--color-bg-alt)]">
                        <tr>
                            <th class="table-header">Nome da Tarefa</th>
                            <th class="table-header">Cargos Associados</th>
                            <th class="table-header text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-[var(--color-card)] divide-y divide-stone-200">`;

            if (state.tarefasPadrao.length === 0) {
                html += `<tr><td colspan="3" class="px-6 py-4 text-center text-stone-500">Nenhuma tarefa cadastrada.</td></tr>`;
            }

            state.tarefasPadrao.forEach(tarefa => {
                const cargosNomes = tarefa.cargoIds?.map(id => {
                    return state.cargos.find(c => c.id === id)?.nome || 'N/A';
                }).join(', ') || 'Nenhum';
                
                html += `
                    <tr>
                        <td class="table-cell font-medium text-stone-900">${tarefa.nome}</td>
                        <td class="table-cell">${cargosNomes}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-action="edit" data-id="${tarefa.id}" class="btn-link">Editar</button>
                            <button data-action="delete" data-id="${tarefa.id}" class="btn-link-danger">Excluir</button>
                        </td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
            dom.adminContent.innerHTML = html;
        }
        
        function renderAdminUsuarios() {
            let html = `<div class="overflow-x-auto bg-[var(--color-card)] rounded-lg shadow-sm">
                <table class="min-w-full divide-y divide-stone-200">
                    <thead class="bg-[var(--color-bg-alt)]">
                        <tr>
                            <th class="table-header">Nome</th>
                            <th class="table-header">Email</th>
                            <th class="table-header">Função (Role)</th>
                            <th class="table-header text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-[var(--color-card)] divide-y divide-stone-200">`;
            
            if (state.usuarios.length === 0) {
                 html += `<tr><td colspan="4" class="px-6 py-4 text-center text-stone-500">Nenhum usuário cadastrado.</td></tr>`;
            }

            state.usuarios.forEach(user => {
                const isCurrentUser = (user.uid === state.currentUser.uid);
                html += `
                    <tr>
                        <td class="table-cell font-medium text-stone-900">${user.nome}</td>
                        <td class="table-cell">${user.email || 'N/A (Visitante/Anônimo)'}</td>
                        <td class="table-cell">
                            <select data-action="change-role" data-uid="${user.uid}" class="form-select text-sm" ${isCurrentUser ? 'disabled' : ''}>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="leitor" ${user.role === 'leitor' ? 'selected' : ''}>Leitor</option>
                            </select>
                        </td>
                        <!-- Botão Excluir Usuário -->
                        <td class="table-cell text-right">
                             <button data-action="delete" data-id="${user.uid}" class="btn-link-danger" 
                                ${isCurrentUser ? 'disabled' : ''} 
                                title="${isCurrentUser ? 'Não pode excluir a si mesmo' : 'Excluir usuário'}">
                                Excluir
                            </button>
                        </td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
            dom.adminContent.innerHTML = html;
        }
        
        // --- NOVA FUNÇÃO ---
        function renderAdminTodasPautas() {
            // 1. Criar o HTML da shell (busca + tabela)
            let html = `
                <div class="bg-[var(--color-card)] rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-stone-700 mb-4">Gerir Todas as Pautas (Atividades)</h2>
                    
                    <!-- Barra de Busca -->
                    <div class="flex mb-4">
                        <input type="search" id="admin-pautas-search" class="form-input flex-grow" placeholder="Buscar por título, funcionário ou cliente...">
                        <button data-action="search-pautas" class="btn-primary ml-2">Buscar</button>
                    </div>

                    <!-- Tabela de Pautas -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-stone-200">
                            <thead class="bg-[var(--color-bg-alt)]">
                                <tr>
                                    <th class="table-header">Data</th>
                                    <th class="table-header">Atividade (Título)</th>
                                    <th class="table-header">Funcionário</th>
                                    <th class="table-header">Cliente</th>
                                    <th class="table-header">Status</th>
                                    <th class="table-header text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="admin-pautas-tbody" class="bg-[var(--color-card)] divide-y divide-stone-200">
                                <!-- Conteúdo será preenchido por JS -->
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            dom.adminContent.innerHTML = html;

            // 2. Preencher a tabela (filtrada)
            const searchTermInput = document.getElementById('admin-pautas-search');
            const searchTerm = searchTermInput ? searchTermInput.value.toLowerCase() : '';
            
            const pautasFiltradas = (searchTerm ? state.atividades.filter(at => {
                const func = state.funcionarios.find(f => f.id === at.funcionarioId)?.nome.toLowerCase() || '';
                const cli = state.clientes.find(c => c.id === at.clienteId)?.nome.toLowerCase() || '';
                return at.titulo.toLowerCase().includes(searchTerm) || 
                       func.includes(searchTerm) || 
                       cli.includes(searchTerm);
            }) : [...state.atividades]) // Usa uma cópia se não filtrar
            .sort((a, b) => new Date(b.data) - new Date(a.data)); // Ordena por data, mais recente primeiro

            const tbody = document.getElementById('admin-pautas-tbody');
            if (!tbody) return;

            if (pautasFiltradas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-stone-500">Nenhuma pauta encontrada.</td></tr>`;
            } else {
                tbody.innerHTML = pautasFiltradas.map(at => {
                    const func = state.funcionarios.find(f => f.id === at.funcionarioId);
                    const cliente = state.clientes.find(c => c.id === at.clienteId);
                    
                    return `
                        <tr>
                            <td class="table-cell">${new Date(at.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
                            <td class="table-cell font-medium text-stone-900">${at.titulo}</td>
                            <td class="table-cell">${func ? func.nome : 'N/A'}</td>
                            <td class="table-cell">${cliente ? cliente.nome : 'N/A'}</td>
                            <td class="table-cell">${at.status || 'Pendente'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button data-action="delete" data-id="${at.id}" class="btn-link-danger">Excluir</button>
                            </td>
                        </tr>`;
                }).join('');
            }
            
            // Restaura o valor da busca
            if(searchTermInput) searchTermInput.value = searchTerm;
        }
        // --- FIM DA NOVA FUNÇÃO ---
        
        function renderAdminPersonalizacao() {
            const s = state.siteSettings || {};
            let html = `
                <div class="bg-[var(--color-card)] rounded-lg shadow-sm p-6">
                    <form id="settings-form" class="space-y-8">
                        
                        <!-- Seção de Cores Globais -->
                        <div>
                            <h3 class="text-lg font-medium text-stone-800 border-b pb-2 mb-4">Cores Globais</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="colorBg" class="block text-sm font-medium text-stone-700">Fundo da Página (Page BG)</label>
                                    <input type="color" id="colorBg" name="colorBg" value="${s.colorBg || '#F4F7FA'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                                <div>
                                    <label for="colorCard" class="block text-sm font-medium text-stone-700">Fundo dos Cartões (Card BG)</label>
                                    <input type="color" id="colorCard" name="colorCard" value="${s.colorCard || '#FFFFFF'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                                <div>
                                    <label for="colorText" class="block text-sm font-medium text-stone-700">Texto Principal (Text)</label>
                                    <input type="color" id="colorText" name="colorText" value="${s.colorText || '#1f2937'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                                <div>
                                    <label for="colorSidebar" class="block text-sm font-medium text-stone-700">Menu Lateral (Sidebar BG)</label>
                                    <input type="color" id="colorSidebar" name="colorSidebar" value="${s.colorSidebar || '#648AAE'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                                <div>
                                    <label for="colorAccent" class="block text-sm font-medium text-stone-700">Destaque (Accent)</label>
                                    <input type="color" id="colorAccent" name="colorAccent" value="${s.colorAccent || '#648AAE'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seção de Cores de Status -->
                        <div>
                            <h3 class="text-lg font-medium text-stone-800 border-b pb-2 mb-4">Cores dos Gráficos (Status)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="colorStatusPendente" class="block text-sm font-medium text-stone-700">Pendente</label>
                                    <input type="color" id="colorStatusPendente" name="colorStatusPendente" value="${s.colorStatusPendente || '#F97422'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                                <div>
                                    <label for="colorStatusEmAndamento" class="block text-sm font-medium text-stone-700">Em Andamento</label>
                                    <input type="color" id="colorStatusEmAndamento" name="colorStatusEmAndamento" value="${s.colorStatusEmAndamento || '#10B981'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                                <div>
                                    <label for="colorStatusBloqueado" class="block text-sm font-medium text-stone-700">Bloqueado</label>
                                    <input type="color" id="colorStatusBloqueado" name="colorStatusBloqueado" value="${s.colorStatusBloqueado || '#EF4444'}" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                                </div>
                            </div>
                            <p class="text-sm text-stone-600 mt-2">A cor 'Concluído' é definida pela 'Cor Destaque (Accent)' global.</p>
                        </div>
                        
                        <!-- Seção de Textos -->
                        <div>
                            <h3 class="text-lg font-medium text-stone-800 border-b pb-2 mb-4">Textos do Menu</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="sidebarTitle" class="block text-sm font-medium text-stone-700">Título Principal</label>
                                    <input type="text" id="sidebarTitle" name="sidebarTitle" value="${s.sidebarTitle || '<span class=&quot;font-normal&quot;>Gestão de</span> Pautas'}" class="form-input">
                                </div>
                                <div>
                                    <label for="menuPautas_text" class="block text-sm font-medium text-stone-700">Botão Pautas</label>
                                    <input type="text" id="menuPautas_text" name="menuPautas_text" value="${s.menuPautas_text || 'Pautas'}" class="form-input">
                                </div>
                                <div>
                                    <label for="menuLancar_text" class="block text-sm font-medium text-stone-700">Botão Lançar</label>
                                    <input type="text" id="menuLancar_text" name="menuLancar_text" value="${s.menuLancar_text || 'Lançar Atividade'}" class="form-input">
                                </div>
                                <div>
                                    <label for="menuDashboard_text" class="block text-sm font-medium text-stone-700">Botão Dashboard</label>
                                    <input type="text" id="menuDashboard_text" name="menuDashboard_text" value="${s.menuDashboard_text || 'Dashboard'}" class="form-input">
                                </div>
                                <div>
                                    <label for="menuAdmin_text" class="block text-sm font-medium text-stone-700">Botão Admin</label>
                                    <input type="text" id="menuAdmin_text" name="menuAdmin_text" value="${s.menuAdmin_text || 'Administrativo'}" class="form-input">
                                </div>
                                <div>
                                    <label for="menuTema_text" class="block text-sm font-medium text-stone-700">Botão Tema</label>
                                    <input type="text" id="menuTema_text" name="menuTema_text" value="${s.menuTema_text || 'Tema'}" class="form-input">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botão Salvar -->
                        <div class="flex justify-end pt-4">
                            <button type="button" data-action="save-settings" id="btn-save-settings" class="btn-primary">
                                Salvar Personalização
                            </button>
                        </div>
                    </form>
                </div>
            `;
            dom.adminContent.innerHTML = html;
        }

        // --- Modals ---
        function openModal(type, id = null) {
            // Apenas 'admin' ou 'editor' podem abrir modais de edição
            if (state.userRole === 'leitor') {
                showToast("Apenas 'editores' e 'admins' podem alterar dados.", 'error');
                return;
            }

            state.editingId = id;
            state.editingCollection = type;
            dom.modalLoading.classList.remove('hidden');
            dom.modalContent.innerHTML = '';
            
            let title = '';
            let html = '';

            if (type === 'atividade') {
                title = id ? 'Editar Atividade' : 'Lançar Atividade';
                const at = id ? state.atividades.find(a => a.id === id) : {};
                const funcOptions = state.funcionarios.map(f => `<option value="${f.id}" ${at?.funcionarioId === f.id ? 'selected' : ''}>${f.nome}</option>`).join('');
                const clienteOptions = state.clientes.map(c => `<option value="${c.id}" ${at?.clienteId === c.id ? 'selected' : ''}>${c.nome}</option>`).join('');
                const statusOptions = ['Pendente', 'Em Andamento', 'Concluído', 'Bloqueado']
                    .map(s => `<option value="${s}" ${at?.status === s ? 'selected' : ''}>${s}</option>`).join('');
                
                let tarefaOptions = '<option value="">Selecione um funcionário primeiro...</option>';
                // Se estiver a editar, pré-popula as tarefas com base no funcionário guardado
                if (id) {
                    const func = state.funcionarios.find(f => f.id === at.funcionarioId);
                    if (func && func.cargoId) {
                        tarefaOptions = state.tarefasPadrao
                            .filter(t => t.cargoIds && t.cargoIds.includes(func.cargoId))
                            .map(t => `<option value="${t.nome}" ${at.titulo === t.nome ? 'selected' : ''}>${t.nome}</option>`)
                            .join('');
                        tarefaOptions = '<option value="">Selecione uma tarefa...</option>' + tarefaOptions;
                    } else {
                         tarefaOptions = '<option value="">Funcionário sem cargo...</option>';
                    }
                }

                html = `
                    <form id="modal-form" class="space-y-4">
                        
                        <!-- 1. Data -->
                        <div>
                            <label for="data" class="block text-sm font-medium text-stone-700">Data</label>
                            <input type="date" id="data" name="data" value="${at.data || new Date().toISOString().split('T')[0]}" class="form-input" required>
                        </div>
                        
                        <!-- 2. Funcionário -->
                        <div>
                            <label for="funcionarioId" class="block text-sm font-medium text-stone-700">Funcionário</label>
                            <select id="funcionarioId" name="funcionarioId" class="form-select" required>
                                <option value="">Selecione...</option>
                                ${funcOptions}
                            </select>
                        </div>
                        
                        <!-- 3. Cargo -->
                        <div>
                            <label for="cargo" class="block text-sm font-medium text-stone-700">Cargo (Automático)</label>
                            <input type="text" id="cargo" name="cargo" class="form-input bg-stone-100 border-stone-200" disabled placeholder="Selecione um funcionário...">
                        </div>

                        <!-- 4. Cliente -->
                        <div>
                            <label for="clienteId" class="block text-sm font-medium text-stone-700">Cliente</label>
                            <select id="clienteId" name="clienteId" class="form-select">
                                <option value="">Selecione...</option>
                                ${clienteOptions}
                            </select>
                        </div>

                        <!-- 5. Tarefa -->
                        <div>
                            <label for="tarefaPadrao" class="block text-sm font-medium text-stone-700">Tarefa Padrão (Filtrada por cargo)</label>
                            <select id="tarefaPadrao" name="tarefaPadrao" class="form-select" ${!id ? 'disabled' : ''}>
                                ${tarefaOptions}
                            </select>
                        </div>

                        <!-- 6. Título -->
                        <div>
                            <label for="titulo" class="block text-sm font-medium text-stone-700">Título da Atividade</label>
                            <input type="text" id="titulo" name="titulo" value="${at.titulo || ''}" class="form-input" required>
                        </div>
                        
                        <!-- 7. Status -->
                        <div>
                            <label for="status" class="block text-sm font-medium text-stone-700">Status</label>
                            <select id="status" name="status" class="form-select">
                                ${statusOptions}
                            </select>
                        </div>
                        
                        <!-- 8. Observações -->
                        <div>
                            <label for="observacoes" class="block text-sm font-medium text-stone-700">Descrição / Observações</label>
                            <textarea id="observacoes" name="observacoes" rows="3" class="form-input">${at.observacoes || ''}</textarea>
                        </div>
                    </form>`;
            } 
            else if (type === 'funcionarios') {
                title = id ? 'Editar Funcionário' : 'Adicionar Funcionário';
                const func = id ? state.funcionarios.find(f => f.id === id) : {};
                const cargoOptions = state.cargos.map(c => `<option value="${c.id}" ${func?.cargoId === c.id ? 'selected' : ''}>${c.nome}</option>`).join('');
                
                html = `
                    <form id="modal-form" class="space-y-4">
                        <div>
                            <label for="nome" class="block text-sm font-medium text-stone-700">Nome Completo</label>
                            <input type="text" id="nome" name="nome" value="${func.nome || ''}" class="form-input" required>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-stone-700">Email</label>
                            <input type="email" id="email" name="email" value="${func.email || ''}" class="form-input">
                        </div>
                        
                        <div>
                            <label for="fotoFile" class="block text-sm font-medium text-stone-700">Foto</label>
                            ${func.fotoUrl ? `<img src="${func.fotoUrl}" alt="Foto atual" class="w-20 h-20 rounded-full object-cover my-2 shadow-md">` : '<div class="w-20 h-20 rounded-full bg-stone-100 flex items-center justify-center my-2 border"><svg class="w-8 h-8 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>'}
                            <input type="file" id="fotoFile" name="fotoFile" class="mt-1 block w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--color-accent-light)] file:text-[var(--color-accent-dark)] hover:file:bg-[var(--color-accent-light-hover)] file:cursor-pointer" accept="image/png, image/jpeg">
                            <input type="hidden" id="fotoUrl" name="fotoUrl" value="${func.fotoUrl || ''}">
                            <p class="text-xs text-stone-500 mt-1">Envie um ficheiro (PNG, JPG). Deixe em branco para manter a foto atual.</p>
                        </div>
                        
                        <div>
                            <label for="cargoId" class="block text-sm font-medium text-stone-700">Cargo</label>
                            <select id="cargoId" name="cargoId" class="form-select" required>
                                <option value="">Selecione...</option>
                                ${cargoOptions}
                            </select>
                        </div>
                    </form>`;
            }
            else if (type === 'cargos') {
                title = id ? 'Editar Cargo' : 'Adicionar Cargo';
                const cargo = id ? state.cargos.find(c => c.id === id) : {};
                html = `
                    <form id="modal-form" class="space-y-4">
                        <div>
                            <label for="nome" class="block text-sm font-medium text-stone-700">Nome do Cargo</label>
                            <input type="text" id="nome" name="nome" value="${cargo.nome || ''}" class="form-input" required>
                        </div>
                    </form>`;
            }
            else if (type === 'clientes') {
                title = id ? 'Editar Cliente' : 'Adicionar Cliente';
                const cliente = id ? state.clientes.find(c => c.id === id) : {};
                html = `
                    <form id="modal-form" class="space-y-4">
                        <div>
                            <label for="nome" class="block text-sm font-medium text-stone-700">Nome do Cliente</label>
                            <input type="text" id="nome" name="nome" value="${cliente.nome || ''}" class="form-input" required>
                        </div>
                    </form>`;
            }
            else if (type === 'tarefas') {
                title = id ? 'Editar Tarefa Padrão' : 'Adicionar Tarefa Padrão';
                const tarefa = id ? state.tarefasPadrao.find(t => t.id === id) : {};
                const cargoOptions = state.cargos.map(c => 
                    `<option value="${c.id}" ${tarefa.cargoIds?.includes(c.id) ? 'selected' : ''}>${c.nome}</option>`
                ).join('');

                html = `
                    <form id="modal-form" class="space-y-4">
                        <div>
                            <label for="nome" class="block text-sm font-medium text-stone-700">Nome da Tarefa</label>
                            <input type="text" id="nome" name="nome" value="${tarefa.nome || ''}" class="form-input" required>
                        </div>
                        <div>
                            <label for="cargoIds" class="block text-sm font-medium text-stone-700">Cargos Associados (Segure Ctrl/Cmd para selecionar vários)</label>
                            <select id="cargoIds" name="cargoIds" multiple class="form-select h-32">
                                ${cargoOptions}
                            </select>
                        </div>
                    </form>`;
            }

            dom.modalTitle.textContent = title;
            dom.modalContent.innerHTML = html;
            dom.modalLoading.classList.add('hidden');
            dom.modal.classList.remove('hidden');

            // Adicionar listener para o select de tarefas padrão
            if (type === 'atividade') {
                const selectTarefa = document.getElementById('tarefaPadrao');
                const inputTitulo = document.getElementById('titulo');
                if (selectTarefa && inputTitulo) {
                    selectTarefa.addEventListener('change', (e) => {
                        if (e.target.value) {
                            inputTitulo.value = e.target.value;
                        }
                    });
                }
                
                const selectFuncionario = document.getElementById('funcionarioId');
                const inputCargo = document.getElementById('cargo');
                
                const updateCargoField = (funcionarioId) => {
                    let foundCargoId = null;
                    if (funcionarioId) {
                        const func = state.funcionarios.find(f => f.id === funcionarioId);
                        if (func && func.cargoId) {
                            foundCargoId = func.cargoId; 
                            const cargo = state.cargos.find(c => c.id === func.cargoId);
                            if (cargo) {
                                inputCargo.value = cargo.nome;
                            } else {
                                inputCargo.value = 'Cargo não encontrado';
                            }
                        } else {
                            inputCargo.value = 'Funcionário sem cargo';
                        }
                    } else {
                        inputCargo.value = 'Selecione um funcionário...';
                    }
                    
                    if (selectTarefa) {
                        if (foundCargoId) {
                            const filteredTarefas = state.tarefasPadrao.filter(t => 
                                t.cargoIds && t.cargoIds.includes(foundCargoId)
                            );
                            let options = '<option value="">Selecione uma tarefa...</option>';
                            options += filteredTarefas.map(t => 
                                `<option value="${t.nome}">${t.nome}</option>`
                            ).join('');
                            selectTarefa.innerHTML = options;
                            selectTarefa.disabled = false;
                        } else {
                            selectTarefa.innerHTML = '<option value="">Selecione um funcionário primeiro...</option>';
                            selectTarefa.disabled = true;
                        }
                    }
                };
                
                if (selectFuncionario && inputCargo) {
                    selectFuncionario.addEventListener('change', (e) => {
                        updateCargoField(e.target.value);
                        const inputTitulo = document.getElementById('titulo');
                        if(inputTitulo) inputTitulo.value = '';
                    });
                }
                
                if (id) {
                    const at = state.atividades.find(a => a.id === id);
                    if (at && at.funcionarioId) {
                         updateCargoField(at.funcionarioId);
                         if (selectTarefa) selectTarefa.value = at.titulo || "";
                    }
                }
            }
        }

        function closeModal() {
            dom.modal.classList.add('hidden');
            state.editingId = null;
            state.editingCollection = null;
        }

        async function handleModalSave() {
            if (state.userRole === 'leitor') return;

            const form = document.getElementById('modal-form');
            if (!form.reportValidity()) return;

            dom.btnModalSave.disabled = true;
            dom.btnModalSave.innerHTML = 'Salvando...';

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            if (state.editingCollection === 'tarefas') {
                const select = form.querySelector('#cargoIds');
                data.cargoIds = Array.from(select.selectedOptions).map(option => option.value);
            }

            let collection;
            let fileToUpload = null;
            let existingFotoUrl = "";

            if (state.editingCollection === 'atividade') collection = atividadesCollection;
            if (state.editingCollection === 'funcionarios') {
                collection = funcionariosCollection;
                existingFotoUrl = data.fotoUrl || "";
                const fotoFileInput = document.getElementById('fotoFile');
                if (fotoFileInput && fotoFileInput.files.length > 0) {
                    fileToUpload = fotoFileInput.files[0];
                }
                delete data.fotoFile; 
            }
            if (state.editingCollection === 'cargos') collection = cargosCollection;
            if (state.editingCollection === 'clientes') collection = clientesCollection;
            if (state.editingCollection === 'tarefas') collection = tarefasPadraoCollection;

            if (!collection) {
                showToast('Erro: Tipo de coleção desconhecido.', 'error');
                dom.btnModalSave.disabled = false;
                dom.btnModalSave.innerHTML = 'Salvar';
                return;
            }

            try {
                if (fileToUpload) { 
                    dom.btnModalSave.innerHTML = 'Enviando foto...';
                    const storageRef = ref(storage, `funcionarios_fotos/${userId}_${Date.now()}_${fileToUpload.name}`);
                    const snapshot = await uploadBytes(storageRef, fileToUpload);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    data.fotoUrl = downloadURL; 
                } else {
                    data.fotoUrl = existingFotoUrl; 
                }
                
                if (state.editingCollection !== 'funcionarios') {
                    delete data.fotoUrl;
                }

                if (state.editingId) {
                    const docRef = doc(db, collection.path, state.editingId);
                    await updateDoc(docRef, data);
                    showToast('Item atualizado com sucesso!', 'success');
                } else {
                    await addDoc(collection, data);
                    showToast('Item salvo com sucesso!', 'success');
                }
                closeModal();
            } catch (error) {
                console.error("Erro ao salvar:", error);
                showToast(`Erro ao salvar: ${error.message}`, 'error');
            } finally {
                dom.btnModalSave.disabled = false;
                dom.btnModalSave.innerHTML = 'Salvar';
            }
        }
        
        function openDeleteModal(id, collection) {
            if (state.userRole === 'leitor') return;
            // Admins podem excluir tudo
            // Editores só podem excluir atividades
            if (state.userRole === 'editor' && collection !== 'atividade') {
                showToast("Apenas 'admins' podem excluir este tipo de item.", 'error');
                return;
            }

            state.editingId = id;
            state.editingCollection = collection;
            dom.confirmDeleteModal.classList.remove('hidden');
        }
        
        async function handleConfirmDelete() {
            if (!state.editingId || !state.editingCollection) return;
            
            let collectionPath;
            if (state.editingCollection === 'atividade') collectionPath = atividadesPath;
            if (state.editingCollection === 'funcionarios') collectionPath = funcionariosPath;
            if (state.editingCollection === 'cargos') collectionPath = cargosPath;
            if (state.editingCollection === 'clientes') collectionPath = clientesPath;
            if (state.editingCollection === 'tarefas') collectionPath = tarefasPadraoPath;
            if (state.editingCollection === 'usuarios') collectionPath = usuariosPath; 

            if (!collectionPath) {
                showToast('Erro: Coleção de exclusão desconhecida.', 'error');
                return;
            }

            try {
                if (state.editingCollection === 'usuarios') {
                    if (state.editingId === state.currentUser.uid) {
                        showToast("Erro: Não pode excluir a si mesmo.", 'error');
                        state.editingId = null;
                        state.editingCollection = null;
                        dom.confirmDeleteModal.classList.add('hidden');
                        return;
                    }
                    // NOTA: Isto apenas remove o usuário da base de dados (remove a função),
                    // não remove o usuário do Firebase Auth.
                }

                const docRef = doc(db, collectionPath, state.editingId);
                await deleteDoc(docRef);
                showToast('Item excluído com sucesso.', 'success');
            } catch (error) {
                console.error("Erro ao excluir:", error);
                showToast(`Erro ao excluir: ${error.message}`, 'error');
            } finally {
                state.editingId = null;
                state.editingCollection = null;
                dom.confirmDeleteModal.classList.add('hidden');
            }
        }

        // --- Utilitários ---
        function showToast(message, type = 'success') {
            dom.toastMessage.textContent = message;
            dom.toast.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            if (type === 'success') {
                dom.toast.classList.add('bg-green-600');
            } else {
                dom.toast.classList.add('bg-red-600');
            }
            setTimeout(() => {
                dom.toast.classList.add('hidden');
            }, 3000);
        }

        // --- Função para Adicionar Dados Iniciais (Mock) ---
        async function seedInitialData() {
            // Esta função só roda se NENHUM cargo estiver cadastrado
            try {
                const cargoQuery = query(cargosCollection, limit(1));
                const cargoSnapshot = await getDocs(cargoQuery);
                
                if (cargoSnapshot.empty) {
                    console.log("Base de dados vazia. Adicionando dados iniciais...");
                    
                    // 1. Cargos
                    const docRefDesigner = await addDoc(cargosCollection, { nome: "Designer" });
                    const cargoDesignerId = docRefDesigner.id;
                    const docRefEdicao = await addDoc(cargosCollection, { nome: "Edição" });
                    const cargoEdicaoId = docRefEdicao.id;

                    // 2. Tarefas (com cargos)
                    await addDoc(tarefasPadraoCollection, { 
                        nome: "Planejamento", 
                        cargoIds: [cargoEdicaoId] 
                    });
                    await addDoc(tarefasPadraoCollection, { 
                        nome: "Design", 
                        cargoIds: [cargoDesignerId] 
                    });
                    await addDoc(tarefasPadraoCollection, { 
                        nome: "KV", 
                        cargoIds: [cargoDesignerId] 
                    });

                    // 3. Funcionários
                    await addDoc(funcionariosCollection, {
                        nome: "Sabrina",
                        email: "sabrina@email.com",
                        cargoId: cargoDesignerId,
                        fotoUrl: "https://placehold.co/100x100/FFF0E7/C75D1B?text=S"
                    });
                    await addDoc(funcionariosCollection, {
                        nome: "Maikon",
                        email: "maikon@email.com",
                        cargoId: cargoEdicaoId,
                        fotoUrl: "https://placehold.co/100x100/E0E8F0/4A698E?text=M"
                    });
                }
            } catch (error) {
                console.error("Erro ao adicionar dados iniciais:", error);
            }
        }

    </script>
    <style>
        :root {
            /* Cores base do layout limpo */
            --color-bg: #F4F7FA; 
            --color-bg-alt: #E9EEF3;
            --color-card: #FFFFFF;
            --color-sidebar: var(--color-accent); 
            --color-sidebar-text: #FFFFFF; 
            --color-sidebar-text-hover: #FFFFFF; 
            --color-sidebar-bg-hover: var(--color-accent-dark); 
            
            --color-text-primary: #1f2937;
            --color-text-secondary: #4b5563;
            
            /* Tema Padrão (Azul Sereno) */
            --color-accent: #648AAE;
            --color-accent-dark: #4A698E;
            --color-accent-darker: #3E5877;
            --color-accent-light: #E0E8F0;
            --color-accent-light-hover: #D0DDE8;
            --color-accent-text: #FFFFFF;
            
            /* Cores de Status Padrão */
            --color-status-concluido: var(--color-accent);
            --color-status-concluido-light: var(--color-accent-light);
            --color-status-concluido-dark: var(--color-accent-dark);
            --color-status-em-andamento: #10B981;
            --color-status-em-andamento-light: #D1FAE5;
            --color-status-em-andamento-dark: #057A55;
            --color-status-pendente: #F97422;
            --color-status-pendente-light: #FFF0E7;
            --color-status-pendente-dark: #C75D1B;
            --color-status-bloqueado: #EF4444;
            --color-status-bloqueado-light: #FEE2E2;
            --color-status-bloqueado-dark: #B91C1C;
        }
        
        /* Temas Rápidos */
        .theme-solar {
            --color-accent: #FFC82E;
            --color-accent-dark: #E6B429;
            --color-accent-darker: #CC9F24;
            --color-accent-light: #FFF8E5;
            --color-accent-light-hover: #FFF1CD;
            --color-accent-text: #1f2937;
        }
        .theme-laranja {
            --color-accent: #F97422;
            --color-accent-dark: #E0691E;
            --color-accent-darker: #C75D1B;
            --color-accent-light: #FFF0E7;
            --color-accent-light-hover: #FFE8D9;
            --color-accent-text: #FFFFFF;
        }

        /* Estilos Globais */
        body {
            color: var(--color-text-primary);
            font-family: var(--font-family);
        }
        
        /* Botões */
        .btn-primary { @apply px-4 py-2 bg-[var(--color-accent)] text-[var(--color-accent-text)] rounded-md shadow-sm font-medium hover:bg-[var(--color-accent-dark)] transition-colors duration-150 flex items-center justify-center; }
        .btn-secondary { @apply px-4 py-2 bg-[var(--color-bg-alt)] text-[var(--color-text-secondary)] rounded-md font-medium hover:bg-stone-300 transition-colors duration-150; }
        .btn-icon { @apply p-2 bg-[var(--color-bg-alt)] text-[var(--color-text-secondary)] rounded-full hover:bg-stone-300 transition-colors duration-150; }
        .btn-link { @apply text-[var(--color-accent-dark)] hover:text-[var(--color-accent-darker)] font-medium transition-colors; }
        .btn-link-danger { @apply text-red-600 hover:text-red-800 font-medium transition-colors; }

        /* Estilo Botões Menu Lateral */
        .menu-btn { @apply flex items-center justify-start w-full px-3 py-3 rounded-md text-base font-medium text-[var(--color-sidebar-text)] hover:text-[var(--color-sidebar-text-hover)] hover:bg-[var(--color-sidebar-bg-hover)] transition-colors duration-150; }
        .menu-btn-active { @apply bg-[var(--color-accent-dark)] text-white font-semibold hover:bg-[var(--color-accent-darker)] hover:text-white; } 

        /* Estilo Botões Sub-Navegação (Pautas, Admin) */
        .sub-nav-btn { @apply px-4 py-2 text-sm font-medium rounded-md transition-colors duration-150 shadow-sm; } 
        .sub-nav-btn-active { @apply bg-[var(--color-accent)] text-[var(--color-accent-text)] font-semibold shadow-sm; } 
        .sub-nav-btn-inactive { @apply bg-white text-[var(--color-text-secondary)] border border-stone-200 hover:bg-stone-50; } 
        
        .theme-swatch { @apply w-6 h-6 rounded-full border border-gray-300 cursor-pointer transition-all; }
        
        /* Estilos de Tabela */
        .table-header { @apply px-6 py-3 text-left text-xs font-medium text-[var(--color-text-secondary)] uppercase tracking-wider; }
        .table-cell { @apply px-6 py-4 whitespace-nowrap text-sm text-[var(--color-text-secondary)]; }

        /* Estilos de Formulário */
        .form-input { @apply mt-1 block w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)] transition-colors; }
        .form-select { @apply mt-1 block w-full px-3 py-2 border border-stone-300 rounded-md shadow-sm focus:ring-[var(--color-accent)] focus:border-[var(--color-accent)] transition-colors; }

        /* Correção para centralização do ícone */
        .sidebar-minimized .sidebar-icon-margin {
            margin-right: 0;
        }

        /* Força o alinhamento do texto à esquerda */
        .sidebar-text {
            @apply text-left;
        }
        
        /* Classes de Status Dinâmicas */
        .status-card-base { @apply p-1.5 rounded-md text-xs cursor-pointer transition-opacity; }
        .status-card-base:hover { opacity: 0.8; }
        .status-concluido { background-color: var(--color-status-concluido-light); color: var(--color-status-concluido-dark); }
        .status-em-andamento { background-color: var(--color-status-em-andamento-light); color: var(--color-status-em-andamento-dark); }
        .status-pendente { background-color: var(--color-status-pendente-light); color: var(--color-status-pendente-dark); }
        .status-bloqueado { background-color: var(--color-status-bloqueado-light); color: var(--color-status-bloqueado-dark); }
        .status-default { background-color: #e5e7eb; color: #4b5563; }
        
        /* NOVO: Estilo para KPI Cards */
        .kpi-card {
            @apply flex justify-between items-center p-3 bg-[var(--color-bg-alt)] rounded-md;
        }
        
    </style>
</head>
<body class="bg-[var(--color-bg)] antialiased" style="font-family: var(--font-family);">

    <!-- Ecrã de Login (Escondido por padrão se app-view estiver visível) -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center bg-[var(--color-bg-alt)] p-4">
        <div class="max-w-md w-full bg-[var(--color-card)] p-8 rounded-xl shadow-lg">
            <h2 id="login-title" class="text-2xl font-bold text-center text-[var(--color-text-primary)] mb-6">Aceder à Plataforma</h2>
            
            <p id="login-message" class="text-center text-red-500 mb-4 text-sm"></p>
            
            <form id="login-form" class="space-y-4">
                <div id="login-name-wrapper" class="hidden">
                    <label for="login-name" class="block text-sm font-medium text-stone-700">Nome</label>
                    <input type="text" id="login-name" name="login-name" class="form-input" placeholder="O seu nome">
                </div>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-stone-700">Email</label>
                    <input type="email" id="login-email" name="login-email" class="form-input" required placeholder="email@exemplo.com">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-stone-700">Senha</label>
                    <input type="password" id="login-password" name="login-password" class="form-input" required placeholder="••••••••">
                </div>
                <button id="login-email-btn" class="btn-primary w-full">Entrar com Email</button>
            </form>

            <div class="text-sm text-center mt-6">
                <button id="toggle-to-create" class="btn-link">Não tem uma conta? Crie uma</button>
                <button id="toggle-to-login" class="btn-link hidden">Já tem uma conta? Entre</button>
            </div>
        </div>
    </div>

    <!-- Aplicação Principal (Escondida por padrão) -->
    <div id="app-view" class="hidden">
        <!-- Menu Lateral (Mobile: escondido por padrão) -->
        <nav id="sidebar-menu" class="fixed inset-y-0 left-0 bg-[var(--color-sidebar)] shadow-md w-64 p-4 z-30 transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out flex flex-col">
            <!-- Logo / Título -->
            <div id="sidebar-title" class="flex items-center justify-start px-3 py-4 mb-4"> 
                <h1 id="sidebar-title-h1" class="text-2xl font-bold text-white"> 
                    <span class="font-normal">Gestão de</span> Pautas
                </h1>
            </div>

            <!-- Itens do Menu -->
            <div class="flex flex-col space-y-2">
                <button id="menu-pautas" class="menu-btn justify-start menu-btn-active">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin sidebar-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span id="menu-pautas-text" class="sidebar-text">Pautas</span>
                </button>
                
                <button id="btn-lancar-atividade-menu" class="menu-btn justify-start">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin sidebar-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="btn-lancar-atividade-menu-text" class="sidebar-text">Lançar Atividade</span>
                </button>

                <button id="menu-dashboard" class="menu-btn justify-start">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin sidebar-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2z"></path></svg>
                    <span id="menu-dashboard-text" class="sidebar-text">Dashboard</span>
                </button>

                <button id="menu-admin" class="menu-btn justify-start">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin sidebar-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span id="menu-admin-text" class="sidebar-text">Administrativo</span>
                </button>

                <button id="menu-tema" class="menu-btn justify-start">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin sidebar-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a4 4 0 014-4h10a4 4 0 014 4v12a4 4 0 01-4 4H7zm0 0l8.5-8.5M7 3v18m8.5-18l-8.5 8.5m0 0L11 11"></path></svg>
                    <span id="menu-tema-text" class="sidebar-text">Tema</span>
                </button>
            </div>
            
            <!-- Controles do Menu (Fundo) -->
            <div class="mt-auto">
                <button id="sidebar-toggle-button" class="menu-btn justify-start">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
                    <!-- Texto "Minimizar" removido -->
                </button>
                
                <button id="btn-logout" class="menu-btn justify-start w-full">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin sidebar-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="sidebar-text text-left">Sair</span>
                </button>

                <div id="user-id-wrapper" class="flex items-center justify-start w-full px-3 py-3 rounded-md text-base font-medium text-white opacity-75">
                    <svg class="w-6 h-6 mr-3 sidebar-icon-margin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span id="user-id-display" class="sidebar-text text-xs truncate">Conectando...</span>
                </div>
            </div>
        </nav>

        <!-- Conteúdo Principal -->
        <main id="main-content-wrapper" class="md:ml-64 transition-all duration-300 ease-in-out">
            <div class="p-4 md:p-8">
                
                <!-- Filtros Globais (Visível em Pautas e Dashboard) -->
                <div id="filtros-globais" class="bg-[var(--color-card)] p-3 rounded-lg shadow-sm mb-4">
                    <h3 class="text-sm font-medium text-stone-600 mb-2">Filtros Globais</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <select id="filter-periodo" class="form-select text-sm">
                            <option value="semana">Esta Semana</option>
                            <option value="mes">Este Mês</option>
                            <option value="hoje">Hoje</option>
                            <option value="todos">Todos</option>
                        </select>
                        <select id="filter-funcionario" class="form-select text-sm">
                            <option value="todos">Todos Funcionários</option>
                        </select>
                        <select id="filter-cargo" class="form-select text-sm">
                            <option value="todos">Todos Cargos</option>
                        </select>
                        <select id="filter-cliente" class="form-select text-sm">
                            <option value="todos">Todos Clientes</option>
                        </select>
                        <select id="filter-tarefa" class="form-select text-sm">
                            <option value="todos">Todas Tarefas</option>
                        </select>
                    </div>
                </div>

                <!-- VIEW: PAUTAS -->
                <div id="main-view-pautas">
                    <div class="flex items-center justify-between mb-4">
                        <div id="pautas-nav" class="flex flex-wrap gap-3">
                            <button data-view="calendario" class="sub-nav-btn sub-nav-btn-active">Calendário</button>
                            <button data-view="semana" class="sub-nav-btn sub-nav-btn-inactive">Semana</button>
                            <button data-view="lista" class="sub-nav-btn sub-nav-btn-inactive">Lista Geral</button>
                        </div>
                    </div>
                    <div id="pautas-content">
                        <!-- Conteúdo Pautas (Calendário/Lista) renderizado aqui -->
                    </div>
                </div>
                
                <!-- VIEW: DASHBOARD -->
                <div id="main-view-dashboard" class="hidden">
                    <div id="dashboard-content">
                        <!-- Conteúdo Dashboard renderizado aqui -->
                    </div>
                </div>
                
                <!-- VIEW: ADMIN -->
                <div id="main-view-admin" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div id="admin-nav" class="flex flex-wrap gap-3">
                            <button data-view="funcionarios" class="sub-nav-btn sub-nav-btn-active">Funcionários</button>
                            <button data-view="cargos" class="sub-nav-btn sub-nav-btn-inactive">Cargos</button>
                            <button data-view="clientes" class="sub-nav-btn sub-nav-btn-inactive">Clientes</button>
                            <button data-view="tarefas" class="sub-nav-btn sub-nav-btn-inactive">Tarefas</button>
                            <button data-view="usuarios" class="sub-nav-btn sub-nav-btn-inactive">Usuários</button>
                            <button data-view="todas-pautas" class="sub-nav-btn sub-nav-btn-inactive">Todas as Pautas</button>
                            <button data-view="personalizacao" class="sub-nav-btn sub-nav-btn-inactive">Personalização</button>
                        </div>
                    </div>
                    <div id="admin-content">
                        <!-- Conteúdo Admin (Tabelas) renderizado aqui -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Principal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modal-title" class="text-lg font-semibold text-stone-800"></h3>
                <button id="btn-modal-close" class="text-stone-500 hover:text-stone-800 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto relative">
                <!-- Formulário renderizado aqui -->
                <div id="modal-loading" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center">
                    <span class="text-blue-600">Carregando...</span>
                </div>
            </div>
            <div class="flex justify-end space-x-3 p-4 bg-[var(--color-bg-alt)] border-t rounded-b-lg">
                <button id="btn-modal-cancel" class="btn-secondary">Cancelar</button>
                <button id="btn-modal-save" class="btn-primary">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div id="confirm-delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-[var(--color-card)] rounded-lg shadow-2xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-lg font-medium text-stone-900">Confirmar Exclusão</h3>
                <p class="mt-2 text-sm text-stone-600">Você tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="flex justify-end space-x-3 p-4 bg-stone-50 rounded-b-lg">
                <button id="btn-cancel-delete" class="btn-secondary">Cancelar</button>
                <button id="btn-confirm-delete" class="px-4 py-2 bg-red-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Tema -->
    <div id="theme-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-[var(--color-card)] rounded-lg shadow-2xl w-full max-w-lg">
             <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold text-stone-800">Personalizar Tema</h3>
                <button id="theme-modal-close" class="text-stone-500 hover:text-stone-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Temas Rápidos -->
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">Temas Rápidos</label>
                    <div class="flex space-x-3">
                        <button id="theme-quick-sereno" class="theme-swatch bg-[#648AAE]" title="Tema Azul Sereno"></button>
                        <button id="theme-quick-solar" class="theme-swatch bg-[#FFC82E]" title="Tema Amarelo Solar"></button>
                        <button id="theme-quick-laranja" class="theme-swatch bg-[#F97422]" title="Tema Laranja"></button>
                    </div>
                </div>
                <!-- Cor Customizada -->
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label for="theme-color-picker" class="block text-sm font-medium text-stone-700">Cor Destaque</label>
                        <input type="color" id="theme-color-picker" class="w-full h-10 p-1 border border-stone-300 rounded-md">
                    </div>
                    <div class="flex-1">
                         <label for="theme-hex-input" class="block text-sm font-medium text-stone-700">Código Hex</label>
                         <input type="text" id="theme-hex-input" class="form-input" placeholder="#648AAE">
                    </div>
                </div>
                <!-- Fontes -->
                <div>
                    <label for="theme-font-select" class="block text-sm font-medium text-stone-700">Fonte da Aplicação</label>
                    <select id="theme-font-select" class="form-select">
                        <option value="Inter">Inter (Padrão)</option>
                        <option value="Roboto Slab">Roboto Slab (Serifada)</option>
                        <option value="Inconsolata">Inconsolata (Mono)</option>
                    </select>
                </div>
                <!-- Tamanho da Fonte -->
                <div>
                    <label class="block text-sm font-medium text-stone-700">Tamanho do Texto</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <button id="theme-font-size-decrease" class="btn-secondary px-4 text-xl font-bold">-</button>
                        <span class="text-lg">Aa</span>
                        <button id="theme-font-size-increase" class="btn-secondary px-4 text-xl font-bold">+</button>
                    </div>
                </div>
                <!-- Resetar -->
                 <div>
                    <button id="theme-reset" class="btn-link text-sm">Restaurar Padrões</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast de Notificação -->
    <div id="toast" class="hidden fixed bottom-4 right-4 max-w-xs text-white px-4 py-3 rounded-lg shadow-lg z-50">
        <span id="toast-message"></span>
    </div>

</body>
</html>
